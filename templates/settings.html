{% extends 'base.html' %}
{% block title %}Settings - SilverSky Partners{% endblock %}

{% block content %}
<header class="header">
    <h1>Settings</h1>
</header>

<main class="content">
    <div class="settings-section-title">Regions</div>
    <div class="card">
        <div id="regionsList" class="tag-list mb-3"></div>
        <div class="flex gap-2">
            <input type="text" class="form-input" id="newRegion" placeholder="Add region (e.g., SoCal)" style="flex: 1;">
            <button class="btn btn-sm" onclick="addRegion()">Add</button>
        </div>
    </div>
    
    <div class="settings-section-title">TSDs (Technology Services Distributors)</div>
    <div class="card">
        <div id="tsdsList" class="tag-list mb-3"></div>
        <div class="flex gap-2">
            <input type="text" class="form-input" id="newTsd" placeholder="Add TSD (e.g., Pax8)" style="flex: 1;">
            <button class="btn btn-sm" onclick="addTsd()">Add</button>
        </div>
    </div>
    
    <div class="settings-section-title">Products</div>
    <div class="card">
        <div id="productsList" class="tag-list mb-3"></div>
        <div class="flex gap-2">
            <input type="text" class="form-input" id="newProduct" placeholder="Add product" style="flex: 1;">
            <button class="btn btn-sm" onclick="addProduct()">Add</button>
        </div>
    </div>
    
    <div class="settings-section-title">Account</div>
    <div class="settings-list">
        <div class="settings-item">
            <span class="settings-item-label">Logged in as</span>
            <span class="settings-item-value">{{ session.get('username', 'admin') }}</span>
        </div>
        <a href="/logout" class="settings-item" style="text-decoration: none; color: var(--error);">
            <span class="settings-item-label">Logout</span>
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
        </a>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
let regions = [], tsds = [], products = [];

async function loadData() {
    const [r1, r2, r3] = await Promise.all([
        fetch('/api/regions'),
        fetch('/api/tsds'),
        fetch('/api/products')
    ]);
    regions = await r1.json();
    tsds = await r2.json();
    products = await r3.json();
    render();
}

function render() {
    document.getElementById('regionsList').innerHTML = regions.map(r => `
        <div class="tag-item">
            ${r.name}
            <button onclick="deleteRegion(${r.id})">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    `).join('') || '<span style="color: var(--text-muted);">No regions yet</span>';
    
    document.getElementById('tsdsList').innerHTML = tsds.map(t => `
        <div class="tag-item">
            ${t.name}
            <button onclick="deleteTsd(${t.id})">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    `).join('') || '<span style="color: var(--text-muted);">No TSDs yet</span>';
    
    document.getElementById('productsList').innerHTML = products.map(p => `
        <div class="tag-item">
            ${p.name}
            <button onclick="deleteProduct(${p.id})">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    `).join('') || '<span style="color: var(--text-muted);">No products yet</span>';
}

async function addRegion() {
    const input = document.getElementById('newRegion');
    const name = input.value.trim();
    if (!name) return;
    
    await fetch('/api/regions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
    });
    
    input.value = '';
    loadData();
}

async function deleteRegion(id) {
    if (!confirm('Delete this region?')) return;
    await fetch(`/api/regions/${id}`, { method: 'DELETE' });
    loadData();
}

async function addTsd() {
    const input = document.getElementById('newTsd');
    const name = input.value.trim();
    if (!name) return;
    
    await fetch('/api/tsds', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
    });
    
    input.value = '';
    loadData();
}

async function deleteTsd(id) {
    if (!confirm('Delete this TSD?')) return;
    await fetch(`/api/tsds/${id}`, { method: 'DELETE' });
    loadData();
}

async function addProduct() {
    const input = document.getElementById('newProduct');
    const name = input.value.trim();
    if (!name) return;
    
    await fetch('/api/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
    });
    
    input.value = '';
    loadData();
}

async function deleteProduct(id) {
    if (!confirm('Delete this product?')) return;
    await fetch(`/api/products/${id}`, { method: 'DELETE' });
    loadData();
}

// Handle enter key
document.getElementById('newRegion').addEventListener('keydown', e => { if (e.key === 'Enter') addRegion(); });
document.getElementById('newTsd').addEventListener('keydown', e => { if (e.key === 'Enter') addTsd(); });
document.getElementById('newProduct').addEventListener('keydown', e => { if (e.key === 'Enter') addProduct(); });

loadData();
</script>
{% endblock %}
