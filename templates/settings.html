{% extends 'base.html' %}
{% block title %}Settings - SilverSky Partners{% endblock %}

{% block content %}
<header class="header">
    <h1>Settings</h1>
</header>

<main class="content">
    <div class="settings-section-title">Appearance</div>
    <div class="card" style="margin-bottom: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-weight: 500;">Theme</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">Switch between dark and light mode</div>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="toggleTheme()" id="themeBtn">
                üåô Dark
            </button>
        </div>
    </div>

    <div class="settings-section-title">Regions</div>
    <div class="card">
        <div id="regionsList" class="tag-list mb-3"></div>
        <div class="flex gap-2">
            <input type="text" class="form-input" id="newRegion" placeholder="Add region (e.g., SoCal)">
            <button class="btn btn-sm" onclick="addRegion()">Add</button>
        </div>
    </div>
    
    <div class="settings-section-title">TSDs (Technology Services Distributors)</div>
    <div class="card">
        <div id="tsdsList" class="tag-list mb-3"></div>
        <div class="flex gap-2">
            <input type="text" class="form-input" id="newTsd" placeholder="Add TSD (e.g., Pax8)">
            <button class="btn btn-sm" onclick="addTsd()">Add</button>
        </div>
    </div>
    
    <div class="settings-section-title">Products</div>
    <div class="card">
        <div id="productsList" class="tag-list mb-3"></div>
        <div class="flex gap-2">
            <input type="text" class="form-input" id="newProduct" placeholder="Add product">
            <button class="btn btn-sm" onclick="addProduct()">Add</button>
        </div>
    </div>
    
    <div class="settings-section-title">Custom Tags</div>
    <div class="card">
        <div id="tagsList" class="tag-list mb-3"></div>
        <div class="flex gap-2">
            <input type="text" class="form-input" id="newTag" placeholder="Add tag (e.g., VIP, Follow-up)">
            <select class="form-select" id="newTagColor" style="width: 100px;">
                <option value="accent">Teal</option>
                <option value="warning">Yellow</option>
                <option value="error">Red</option>
                <option value="secondary">Gray</option>
            </select>
            <button class="btn btn-sm" onclick="addTag()">Add</button>
        </div>
    </div>
    
    <div class="settings-section-title">Account</div>
    <div class="settings-list">
        <a href="/logout" class="settings-item" style="text-decoration: none; color: var(--error);">
            <span class="settings-item-label">Logout</span>
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
        </a>
    </div>
</main>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal">
        <div class="modal-handle"></div>
        <h2 class="modal-title" id="editModalTitle">Edit</h2>
        <div class="form-group">
            <label class="form-label">Name</label>
            <input type="text" class="form-input" id="editName">
        </div>
        <div class="form-group" id="editColorGroup" style="display: none;">
            <label class="form-label">Color</label>
            <select class="form-select" id="editColor">
                <option value="accent">Teal</option>
                <option value="warning">Yellow</option>
                <option value="error">Red</option>
                <option value="secondary">Gray</option>
            </select>
        </div>
        <input type="hidden" id="editType">
        <input type="hidden" id="editItemId">
        <div class="flex gap-2 mt-4">
            <button class="btn btn-secondary" onclick="closeModal('editModal')" style="flex: 1;">Cancel</button>
            <button class="btn" onclick="saveEdit()" style="flex: 1;">Save</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let regions = [], tsds = [], products = [], tags = [];

// Update theme button text on load
function updateThemeBtn() {
    const theme = document.documentElement.getAttribute('data-theme') || 'dark';
    document.getElementById('themeBtn').textContent = theme === 'dark' ? 'üåô Dark' : '‚òÄÔ∏è Light';
}
updateThemeBtn();

// Override toggleTheme to also update button
const originalToggleTheme = window.toggleTheme;
window.toggleTheme = function() {
    originalToggleTheme();
    updateThemeBtn();
};

async function loadData() {
    try {
        const [r1, r2, r3, r4] = await Promise.all([
            fetch('/api/regions'),
            fetch('/api/tsds'),
            fetch('/api/products'),
            fetch('/api/tags')
        ]);
        regions = await r1.json();
        tsds = await r2.json();
        products = await r3.json();
        tags = await r4.json();
        render();
    } catch (err) {
        console.error('Failed to load data:', err);
    }
}

function getTagColorStyle(color) {
    const colors = {
        accent: 'background: rgba(0, 212, 170, 0.15); color: var(--accent);',
        warning: 'background: rgba(255, 187, 0, 0.15); color: var(--warning);',
        error: 'background: rgba(255, 85, 102, 0.15); color: var(--error);',
        secondary: 'background: var(--bg-hover); color: var(--text-secondary);'
    };
    return colors[color] || colors.secondary;
}

function render() {
    // Regions
    const regionsEl = document.getElementById('regionsList');
    if (regions.length === 0) {
        regionsEl.innerHTML = '<span style="color: var(--text-muted);">No regions yet</span>';
    } else {
        regionsEl.innerHTML = regions.map(r => `
            <div class="tag-item">
                <span style="flex: 1;">${escapeHtml(r.name)}</span>
                <button onclick="openEdit('region', ${r.id})" title="Edit" style="margin-right: 4px;">‚úé</button>
                <button onclick="deleteItem('region', ${r.id})" title="Delete">‚úï</button>
            </div>
        `).join('');
    }
    
    // TSDs
    const tsdsEl = document.getElementById('tsdsList');
    if (tsds.length === 0) {
        tsdsEl.innerHTML = '<span style="color: var(--text-muted);">No TSDs yet</span>';
    } else {
        tsdsEl.innerHTML = tsds.map(t => `
            <div class="tag-item">
                <span style="flex: 1;">${escapeHtml(t.name)}</span>
                <button onclick="openEdit('tsd', ${t.id})" title="Edit" style="margin-right: 4px;">‚úé</button>
                <button onclick="deleteItem('tsd', ${t.id})" title="Delete">‚úï</button>
            </div>
        `).join('');
    }
    
    // Products
    const productsEl = document.getElementById('productsList');
    if (products.length === 0) {
        productsEl.innerHTML = '<span style="color: var(--text-muted);">No products yet</span>';
    } else {
        productsEl.innerHTML = products.map(p => `
            <div class="tag-item">
                <span style="flex: 1;">${escapeHtml(p.name)}</span>
                <button onclick="openEdit('product', ${p.id})" title="Edit" style="margin-right: 4px;">‚úé</button>
                <button onclick="deleteItem('product', ${p.id})" title="Delete">‚úï</button>
            </div>
        `).join('');
    }
    
    // Tags
    const tagsEl = document.getElementById('tagsList');
    if (tags.length === 0) {
        tagsEl.innerHTML = '<span style="color: var(--text-muted);">No custom tags yet</span>';
    } else {
        tagsEl.innerHTML = tags.map(t => `
            <div class="tag-item" style="${getTagColorStyle(t.color)}">
                <span style="flex: 1;">${escapeHtml(t.name)}</span>
                <button onclick="openEdit('tag', ${t.id})" title="Edit" style="margin-right: 4px;">‚úé</button>
                <button onclick="deleteItem('tag', ${t.id})" title="Delete">‚úï</button>
            </div>
        `).join('');
    }
}

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

async function addRegion() {
    const input = document.getElementById('newRegion');
    const name = input.value.trim();
    if (!name) return;
    
    const res = await fetch('/api/regions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
    });
    if (res.ok) {
        input.value = '';
        showToast('Region added');
        loadData();
    }
}

async function addTsd() {
    const input = document.getElementById('newTsd');
    const name = input.value.trim();
    if (!name) return;
    
    const res = await fetch('/api/tsds', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
    });
    if (res.ok) {
        input.value = '';
        showToast('TSD added');
        loadData();
    }
}

async function addProduct() {
    const input = document.getElementById('newProduct');
    const name = input.value.trim();
    if (!name) return;
    
    const res = await fetch('/api/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
    });
    if (res.ok) {
        input.value = '';
        showToast('Product added');
        loadData();
    }
}

async function addTag() {
    const input = document.getElementById('newTag');
    const colorSelect = document.getElementById('newTagColor');
    const name = input.value.trim();
    const color = colorSelect.value;
    if (!name) return;
    
    const res = await fetch('/api/tags', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, color })
    });
    if (res.ok) {
        input.value = '';
        showToast('Tag added');
        loadData();
    }
}

async function deleteItem(type, id) {
    if (!confirm('Delete this ' + type + '?')) return;
    
    let url = '/api/' + type + 's/' + id;
    await fetch(url, { method: 'DELETE' });
    showToast(type.charAt(0).toUpperCase() + type.slice(1) + ' deleted');
    loadData();
}

function openEdit(type, id) {
    let item;
    if (type === 'region') item = regions.find(r => r.id === id);
    else if (type === 'tsd') item = tsds.find(t => t.id === id);
    else if (type === 'product') item = products.find(p => p.id === id);
    else if (type === 'tag') item = tags.find(t => t.id === id);
    
    if (!item) return;
    
    document.getElementById('editType').value = type;
    document.getElementById('editItemId').value = id;
    document.getElementById('editName').value = item.name;
    document.getElementById('editModalTitle').textContent = 'Edit ' + type.charAt(0).toUpperCase() + type.slice(1);
    
    // Show/hide color picker for tags
    const colorGroup = document.getElementById('editColorGroup');
    if (type === 'tag') {
        colorGroup.style.display = 'block';
        document.getElementById('editColor').value = item.color || 'accent';
    } else {
        colorGroup.style.display = 'none';
    }
    
    openModal('editModal');
}

async function saveEdit() {
    const type = document.getElementById('editType').value;
    const id = document.getElementById('editItemId').value;
    const name = document.getElementById('editName').value.trim();
    
    if (!name) return;
    
    let url = '/api/' + type + 's/' + id;
    let body = { name };
    
    if (type === 'tag') {
        body.color = document.getElementById('editColor').value;
    }
    
    const res = await fetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    });
    
    if (res.ok) {
        closeModal('editModal');
        showToast(type.charAt(0).toUpperCase() + type.slice(1) + ' updated');
        loadData();
    } else {
        showToast('Failed to save', 'error');
    }
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

document.querySelectorAll('.modal-overlay').forEach(o => {
    o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); });
});

document.getElementById('newRegion').addEventListener('keydown', e => { if (e.key === 'Enter') addRegion(); });
document.getElementById('newTsd').addEventListener('keydown', e => { if (e.key === 'Enter') addTsd(); });
document.getElementById('newProduct').addEventListener('keydown', e => { if (e.key === 'Enter') addProduct(); });
document.getElementById('newTag').addEventListener('keydown', e => { if (e.key === 'Enter') addTag(); });

loadData();
</script>
{% endblock %}
