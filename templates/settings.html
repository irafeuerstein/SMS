{% extends 'base.html' %}
{% block title %}Settings - SilverSky Partners{% endblock %}

{% block content %}
<header class="header">
    <h1>Settings</h1>
</header>

<main class="content">
    <div class="settings-section-title">Regions</div>
    <div class="card">
        <div id="regionsList" class="tag-list mb-3"></div>
        <div class="flex gap-2">
            <input type="text" class="form-input" id="newRegion" placeholder="Add region (e.g., SoCal)">
            <button class="btn btn-sm" onclick="addRegion()">Add</button>
        </div>
    </div>
    
    <div class="settings-section-title">TSDs (Technology Services Distributors)</div>
    <div class="card">
        <div id="tsdsList" class="tag-list mb-3"></div>
        <div class="flex gap-2">
            <input type="text" class="form-input" id="newTsd" placeholder="Add TSD (e.g., Pax8)">
            <button class="btn btn-sm" onclick="addTsd()">Add</button>
        </div>
    </div>
    
    <div class="settings-section-title">Products</div>
    <div class="card">
        <div id="productsList" class="tag-list mb-3"></div>
        <div class="flex gap-2">
            <input type="text" class="form-input" id="newProduct" placeholder="Add product">
            <button class="btn btn-sm" onclick="addProduct()">Add</button>
        </div>
    </div>
    
    <div class="settings-section-title">Account</div>
    <div class="settings-list">
        <a href="/logout" class="settings-item" style="text-decoration: none; color: var(--error);">
            <span class="settings-item-label">Logout</span>
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
        </a>
    </div>
</main>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal">
        <div class="modal-handle"></div>
        <h2 class="modal-title" id="editModalTitle">Edit</h2>
        <div class="form-group">
            <label class="form-label">Name</label>
            <input type="text" class="form-input" id="editName">
        </div>
        <input type="hidden" id="editType">
        <input type="hidden" id="editItemId">
        <div class="flex gap-2 mt-4">
            <button class="btn btn-secondary" onclick="closeModal('editModal')" style="flex: 1;">Cancel</button>
            <button class="btn" onclick="saveEdit()" style="flex: 1;">Save</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let regions = [], tsds = [], products = [];

async function loadData() {
    try {
        const [r1, r2, r3] = await Promise.all([
            fetch('/api/regions'),
            fetch('/api/tsds'),
            fetch('/api/products')
        ]);
        regions = await r1.json();
        tsds = await r2.json();
        products = await r3.json();
        render();
    } catch (err) {
        console.error('Failed to load data:', err);
    }
}

function render() {
    // Regions
    const regionsEl = document.getElementById('regionsList');
    if (regions.length === 0) {
        regionsEl.innerHTML = '<span style="color: var(--text-muted);">No regions yet</span>';
    } else {
        regionsEl.innerHTML = regions.map(r => `
            <div class="tag-item">
                <span style="flex: 1;">${escapeHtml(r.name)}</span>
                <button onclick="openEdit('region', ${r.id})" title="Edit" style="margin-right: 4px;">✎</button>
                <button onclick="deleteItem('region', ${r.id})" title="Delete">✕</button>
            </div>
        `).join('');
    }
    
    // TSDs
    const tsdsEl = document.getElementById('tsdsList');
    if (tsds.length === 0) {
        tsdsEl.innerHTML = '<span style="color: var(--text-muted);">No TSDs yet</span>';
    } else {
        tsdsEl.innerHTML = tsds.map(t => `
            <div class="tag-item">
                <span style="flex: 1;">${escapeHtml(t.name)}</span>
                <button onclick="openEdit('tsd', ${t.id})" title="Edit" style="margin-right: 4px;">✎</button>
                <button onclick="deleteItem('tsd', ${t.id})" title="Delete">✕</button>
            </div>
        `).join('');
    }
    
    // Products
    const productsEl = document.getElementById('productsList');
    if (products.length === 0) {
        productsEl.innerHTML = '<span style="color: var(--text-muted);">No products yet</span>';
    } else {
        productsEl.innerHTML = products.map(p => `
            <div class="tag-item">
                <span style="flex: 1;">${escapeHtml(p.name)}</span>
                <button onclick="openEdit('product', ${p.id})" title="Edit" style="margin-right: 4px;">✎</button>
                <button onclick="deleteItem('product', ${p.id})" title="Delete">✕</button>
            </div>
        `).join('');
    }
}

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

async function addRegion() {
    const input = document.getElementById('newRegion');
    const name = input.value.trim();
    if (!name) return;
    
    const res = await fetch('/api/regions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
    });
    if (res.ok) {
        input.value = '';
        loadData();
    }
}

async function addTsd() {
    const input = document.getElementById('newTsd');
    const name = input.value.trim();
    if (!name) return;
    
    const res = await fetch('/api/tsds', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
    });
    if (res.ok) {
        input.value = '';
        loadData();
    }
}

async function addProduct() {
    const input = document.getElementById('newProduct');
    const name = input.value.trim();
    if (!name) return;
    
    const res = await fetch('/api/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
    });
    if (res.ok) {
        input.value = '';
        loadData();
    }
}

async function deleteItem(type, id) {
    if (!confirm('Delete this ' + type + '?')) return;
    
    let url = '/api/' + type + 's/' + id;
    await fetch(url, { method: 'DELETE' });
    loadData();
}

function openEdit(type, id) {
    let item;
    if (type === 'region') item = regions.find(r => r.id === id);
    else if (type === 'tsd') item = tsds.find(t => t.id === id);
    else if (type === 'product') item = products.find(p => p.id === id);
    
    if (!item) return;
    
    document.getElementById('editType').value = type;
    document.getElementById('editItemId').value = id;
    document.getElementById('editName').value = item.name;
    document.getElementById('editModalTitle').textContent = 'Edit ' + type.charAt(0).toUpperCase() + type.slice(1);
    openModal('editModal');
}

async function saveEdit() {
    const type = document.getElementById('editType').value;
    const id = document.getElementById('editItemId').value;
    const name = document.getElementById('editName').value.trim();
    
    if (!name) return;
    
    let url = '/api/' + type + 's/' + id;
    
    const res = await fetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
    });
    
    if (res.ok) {
        closeModal('editModal');
        loadData();
    } else {
        alert('Failed to save');
    }
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

document.querySelectorAll('.modal-overlay').forEach(o => {
    o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); });
});

document.getElementById('newRegion').addEventListener('keydown', e => { if (e.key === 'Enter') addRegion(); });
document.getElementById('newTsd').addEventListener('keydown', e => { if (e.key === 'Enter') addTsd(); });
document.getElementById('newProduct').addEventListener('keydown', e => { if (e.key === 'Enter') addProduct(); });

loadData();
</script>
{% endblock %}
