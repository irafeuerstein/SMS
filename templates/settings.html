{% extends 'base.html' %}
{% block title %}Settings - SilverSky SMS{% endblock %}

{% block extra_css %}
<style>
    .settings-group {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        margin-bottom: 12px;
        overflow: hidden;
    }
    .settings-group-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        cursor: pointer;
        transition: background 0.15s ease;
    }
    .settings-group-header:active {
        background: var(--bg-hover);
    }
    .settings-group-title {
        font-weight: 600;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .settings-group-title .icon {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }
    .settings-group-chevron {
        color: var(--text-muted);
        transition: transform 0.2s ease;
    }
    .settings-group.open .settings-group-chevron {
        transform: rotate(180deg);
    }
    .settings-group-content {
        display: none;
        padding: 0 16px 16px;
        border-top: 1px solid var(--border);
    }
    .settings-group.open .settings-group-content {
        display: block;
    }
    .settings-group-subtitle {
        font-size: 0.8rem;
        color: var(--text-muted);
    }
    .step-indicator {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.75rem;
        background: var(--bg-hover);
        color: var(--text-muted);
    }
    .step-indicator.active {
        background: var(--ai-gradient);
        color: white;
    }
    .step-indicator.done {
        background: var(--accent);
        color: var(--bg-primary);
    }
    .ai-step {
        padding: 14px;
        background: var(--bg-hover);
        border-radius: var(--radius-md);
        margin-bottom: 12px;
    }
    .ai-step:last-child {
        margin-bottom: 0;
    }
    .ai-step-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }
    .ai-step-title {
        font-weight: 600;
        font-size: 0.9rem;
    }
    .ai-step-desc {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 12px;
    }
</style>
{% endblock %}

{% block content %}
<header class="header">
    <h1>
        <div class="logo-mark">S</div>
        Settings
    </h1>
</header>

<main class="content">
    <!-- Appearance -->
    <div class="settings-group open">
        <div class="settings-group-header" onclick="toggleSettingsGroup(this)">
            <div class="settings-group-title">
                <div class="icon" style="background: var(--bg-hover);">üé®</div>
                <div>
                    <div>Appearance</div>
                    <div class="settings-group-subtitle">Theme & display</div>
                </div>
            </div>
            <svg class="settings-group-chevron" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </div>
        <div class="settings-group-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 500;">Theme</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">Dark or light mode</div>
                </div>
                <button class="btn btn-sm btn-secondary" onclick="toggleTheme()" id="themeBtn">üåô Dark</button>
            </div>
        </div>
    </div>

    <!-- Contact Data -->
    <div class="settings-group">
        <div class="settings-group-header" onclick="toggleSettingsGroup(this)">
            <div class="settings-group-title">
                <div class="icon" style="background: var(--accent-dim);">üìã</div>
                <div>
                    <div>Contact Data</div>
                    <div class="settings-group-subtitle">Regions, TSDs, Products, Tags</div>
                </div>
            </div>
            <svg class="settings-group-chevron" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </div>
        <div class="settings-group-content">
            <!-- Regions -->
            <div style="margin-bottom: 20px;">
                <div style="font-weight: 500; margin-bottom: 8px;">Regions</div>
                <div id="regionsList" class="tag-list mb-2"></div>
                <div class="flex gap-2">
                    <input type="text" class="form-input" id="newRegion" placeholder="Add region..." style="flex: 1;">
                    <button class="btn btn-sm" onclick="addRegion()">Add</button>
                </div>
            </div>
            
            <!-- TSDs -->
            <div style="margin-bottom: 20px;">
                <div style="font-weight: 500; margin-bottom: 8px;">TSDs</div>
                <div id="tsdsList" class="tag-list mb-2"></div>
                <div class="flex gap-2">
                    <input type="text" class="form-input" id="newTsd" placeholder="Add TSD..." style="flex: 1;">
                    <button class="btn btn-sm" onclick="addTsd()">Add</button>
                </div>
            </div>
            
            <!-- Products -->
            <div style="margin-bottom: 20px;">
                <div style="font-weight: 500; margin-bottom: 8px;">Products</div>
                <div id="productsList" class="tag-list mb-2"></div>
                <div class="flex gap-2">
                    <input type="text" class="form-input" id="newProduct" placeholder="Add product..." style="flex: 1;">
                    <button class="btn btn-sm" onclick="addProduct()">Add</button>
                </div>
            </div>
            
            <!-- Tags -->
            <div>
                <div style="font-weight: 500; margin-bottom: 8px;">Custom Tags</div>
                <div id="tagsList" class="tag-list mb-2"></div>
                <div class="flex gap-2">
                    <input type="text" class="form-input" id="newTag" placeholder="Add tag..." style="flex: 1;">
                    <select class="form-select" id="newTagColor" style="width: 90px;">
                        <option value="accent">Teal</option>
                        <option value="warning">Yellow</option>
                        <option value="error">Red</option>
                        <option value="secondary">Gray</option>
                    </select>
                    <button class="btn btn-sm" onclick="addTag()">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Training -->
    <div class="settings-group">
        <div class="settings-group-header" onclick="toggleSettingsGroup(this)">
            <div class="settings-group-title">
                <div class="icon" style="background: var(--ai-dim);">‚ú®</div>
                <div>
                    <div style="background: var(--ai-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">AI Training</div>
                    <div class="settings-group-subtitle"><span id="knowledgeCount">0</span> items learned</div>
                </div>
            </div>
            <svg class="settings-group-chevron" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </div>
        <div class="settings-group-content">
            <!-- Step 1: Import Website -->
            <div class="ai-step" style="border: 1px solid rgba(102, 126, 234, 0.3);">
                <div class="ai-step-header">
                    <div class="step-indicator active" id="step1Ind">1</div>
                    <div class="ai-step-title">Import Your Website</div>
                </div>
                <div class="ai-step-desc">Auto-extract products, company info, and selling points.</div>
                <div class="flex gap-2">
                    <input type="text" class="form-input" id="scrapeUrl" placeholder="yoursite.com" style="flex: 1;">
                    <button class="btn btn-sm btn-ai" onclick="scrapeWebsite()" id="scrapeBtn">üîç Import</button>
                </div>
                <div id="scrapeStatus" style="font-size: 0.75rem; margin-top: 8px;"></div>
            </div>
            
            <!-- Step 2: Review -->
            <div class="ai-step">
                <div class="ai-step-header">
                    <div class="step-indicator" id="step2Ind">2</div>
                    <div class="ai-step-title">Review Knowledge Base</div>
                </div>
                <div class="ai-step-desc">Check, edit, or delete what AI learned.</div>
                <button class="btn btn-sm btn-secondary" onclick="openModal('aiTrainingModal')">üìö View Knowledge</button>
            </div>
            
            <!-- Step 3: Objections -->
            <div class="ai-step">
                <div class="ai-step-header">
                    <div class="step-indicator" id="step3Ind">3</div>
                    <div class="ai-step-title">Add Objection Responses</div>
                </div>
                <div class="ai-step-desc">Teach AI how to handle common pushbacks.</div>
                <div class="flex gap-2 mb-2" style="flex-wrap: wrap;">
                    <button class="btn btn-sm btn-ghost" onclick="addSuggestedObjection('Too expensive')">+ Too expensive</button>
                    <button class="btn btn-sm btn-ghost" onclick="addSuggestedObjection('Already have solution')">+ Have solution</button>
                    <button class="btn btn-sm btn-ghost" onclick="addSuggestedObjection('Not right time')">+ Not right time</button>
                </div>
                <input type="text" class="form-input mb-2" id="objectionTitle" placeholder="Objection...">
                <textarea class="form-textarea mb-2" id="objectionResponse" rows="2" placeholder="How to respond..."></textarea>
                <button class="btn btn-sm" onclick="addObjection()">+ Add Response</button>
            </div>
            
            <!-- Step 4: Writing Style -->
            <div class="ai-step">
                <div class="ai-step-header">
                    <div class="step-indicator" id="step4Ind">4</div>
                    <div class="ai-step-title">Learn Your Style</div>
                </div>
                <div class="ai-step-desc">AI learns to write like you.</div>
                <button class="btn btn-sm btn-ai mb-3" onclick="analyzeMyStyle()" id="analyzeStyleBtn">‚ú® Analyze My Messages</button>
                <div id="analyzeStatus" style="font-size: 0.75rem; margin-bottom: 8px;"></div>
                <div class="flex gap-2 mb-2" style="flex-wrap: wrap;">
                    <button class="btn btn-sm btn-ghost" onclick="setTonePreset('casual')">üòä Casual</button>
                    <button class="btn btn-sm btn-ghost" onclick="setTonePreset('professional')">üëî Professional</button>
                    <button class="btn btn-sm btn-ghost" onclick="setTonePreset('consultative')">ü§ù Consultative</button>
                </div>
                <textarea class="form-textarea mb-2" id="toneDescription" rows="2" placeholder="Or describe your style..."></textarea>
                <button class="btn btn-sm" onclick="saveTone()">üíæ Save Style</button>
            </div>
            
            <!-- Step 5: Add More -->
            <div class="ai-step">
                <div class="ai-step-header">
                    <div class="step-indicator" id="step5Ind">5</div>
                    <div class="ai-step-title">Add More Knowledge</div>
                </div>
                <div class="ai-step-desc">FAQs, pricing, competitive info, etc.</div>
                <select class="form-select mb-2" id="quickCategory">
                    <option value="products">üì¶ Products</option>
                    <option value="faq">‚ùì FAQ</option>
                    <option value="general">üìã General</option>
                    <option value="objections">üõ°Ô∏è Objections</option>
                </select>
                <input type="text" class="form-input mb-2" id="quickTitle" placeholder="Title...">
                <textarea class="form-textarea mb-2" id="quickContent" rows="2" placeholder="Content..."></textarea>
                <button class="btn btn-sm" onclick="quickAddKnowledge()">+ Add</button>
            </div>
        </div>
    </div>

    <!-- Team (Admin only) -->
    {% if current_user and current_user.is_admin %}
    <div class="settings-group">
        <div class="settings-group-header" onclick="toggleSettingsGroup(this)">
            <div class="settings-group-title">
                <div class="icon" style="background: rgba(0, 212, 170, 0.15);">üë•</div>
                <div>
                    <div>Team</div>
                    <div class="settings-group-subtitle">Manage team members</div>
                </div>
            </div>
            <svg class="settings-group-chevron" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </div>
        <div class="settings-group-content">
            <div style="margin-bottom: 12px;">
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px;">Add team members, manage permissions, and reassign contacts.</div>
                <a href="/admin/users" class="btn btn-block" style="text-decoration: none;">üë• Manage Team Members</a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Account -->
    <div class="settings-group">
        <div class="settings-group-header" onclick="toggleSettingsGroup(this)">
            <div class="settings-group-title">
                <div class="icon" style="background: rgba(255, 77, 106, 0.15);">üë§</div>
                <div>
                    <div>Account</div>
                    <div class="settings-group-subtitle">Password, calendar & app info</div>
                </div>
            </div>
            <svg class="settings-group-chevron" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </div>
        <div class="settings-group-content">
            <!-- Calendar Link -->
            <div style="margin-bottom: 20px;">
                <div style="font-weight: 500; margin-bottom: 8px;">üìÖ Calendar Link</div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">AI will use this when suggesting meeting bookings</div>
                <div class="flex gap-2">
                    <input type="text" class="form-input" id="calendarLink" placeholder="https://calendly.com/yourname" style="flex: 1;">
                    <button class="btn btn-sm" onclick="saveCalendarLink()">Save</button>
                </div>
            </div>
            
            <!-- Change Password -->
            <div style="margin-bottom: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                <div style="font-weight: 500; margin-bottom: 8px;">üîí Change Password</div>
                <div class="form-group mb-2">
                    <input type="password" class="form-input" id="currentPassword" placeholder="Current password">
                </div>
                <div class="form-group mb-2">
                    <input type="password" class="form-input" id="newPassword" placeholder="New password (min 6 chars)">
                </div>
                <button class="btn btn-sm btn-secondary" onclick="changePassword()">Update Password</button>
            </div>
            
            <!-- Restart Onboarding -->
            <div style="margin-bottom: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                <div style="font-weight: 500; margin-bottom: 8px;">üîÑ Setup Wizard</div>
                <a href="/onboarding" class="btn btn-sm btn-ghost" style="text-decoration: none;">Restart Setup Wizard</a>
            </div>
            
            <!-- Logout -->
            <div style="padding-top: 16px; border-top: 1px solid var(--border);">
                <a href="/logout" class="btn btn-secondary btn-block mb-3" style="color: var(--error); text-decoration: none;">
                    Logout
                </a>
            </div>
            
            <!-- Version -->
            <div style="text-align: center; padding-top: 12px; border-top: 1px solid var(--border);">
                <div style="font-size: 0.75rem; color: var(--text-muted);">SilverSky SMS</div>
                <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary);">Version 1.4.0</div>
            </div>
        </div>
    </div>
</main>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal">
        <div class="modal-handle"></div>
        <h2 class="modal-title" id="editModalTitle">Edit</h2>
        <div class="form-group">
            <label class="form-label">Name</label>
            <input type="text" class="form-input" id="editName">
        </div>
        <div class="form-group hidden" id="editColorGroup">
            <label class="form-label">Color</label>
            <select class="form-select" id="editColor">
                <option value="accent">Teal</option>
                <option value="warning">Yellow</option>
                <option value="error">Red</option>
                <option value="secondary">Gray</option>
            </select>
        </div>
        <input type="hidden" id="editType">
        <input type="hidden" id="editItemId">
        <div class="flex gap-2 mt-4">
            <button class="btn btn-secondary" onclick="closeModal('editModal')" style="flex: 1;">Cancel</button>
            <button class="btn" onclick="saveEdit()" style="flex: 1;">Save</button>
        </div>
    </div>
</div>

<!-- AI Training Modal -->
<div class="modal-overlay" id="aiTrainingModal">
    <div class="modal" style="max-height: 80vh;">
        <div class="modal-handle"></div>
        <h2 class="modal-title">üìö Knowledge Base</h2>
        <div id="knowledgeList"></div>
        <button class="btn btn-secondary btn-block mt-4" onclick="closeModal('aiTrainingModal')">Close</button>
    </div>
</div>

<!-- Edit Knowledge Modal -->
<div class="modal-overlay" id="editKnowledgeModal">
    <div class="modal">
        <div class="modal-handle"></div>
        <h2 class="modal-title" id="editKnowledgeTitle">Edit Knowledge</h2>
        <div class="form-group">
            <label class="form-label">Category</label>
            <select class="form-select" id="editKnowledgeCategory">
                <option value="products">Products</option>
                <option value="objections">Objections</option>
                <option value="faq">FAQ</option>
                <option value="tone">Tone</option>
                <option value="general">General</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Title</label>
            <input type="text" class="form-input" id="editKnowledgeTitleInput">
        </div>
        <div class="form-group">
            <label class="form-label">Content</label>
            <textarea class="form-textarea" id="editKnowledgeContent" rows="4"></textarea>
        </div>
        <input type="hidden" id="editKnowledgeId">
        <div class="flex gap-2 mt-4">
            <button class="btn btn-secondary" onclick="closeModal('editKnowledgeModal')" style="flex: 1;">Cancel</button>
            <button class="btn" onclick="saveKnowledge()" style="flex: 1;">Save</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let regions = [], tsds = [], products = [], tags = [], knowledge = [];

function toggleSettingsGroup(header) {
    header.parentElement.classList.toggle('open');
}

function updateThemeBtn() {
    const theme = document.documentElement.getAttribute('data-theme') || 'dark';
    document.getElementById('themeBtn').textContent = theme === 'dark' ? 'üåô Dark' : '‚òÄÔ∏è Light';
}
updateThemeBtn();

const originalToggleTheme = window.toggleTheme;
window.toggleTheme = function() {
    originalToggleTheme();
    updateThemeBtn();
};

async function loadData() {
    try {
        const [r1, r2, r3, r4] = await Promise.all([
            fetch('/api/regions'), fetch('/api/tsds'), fetch('/api/products'), fetch('/api/tags')
        ]);
        regions = await r1.json();
        tsds = await r2.json();
        products = await r3.json();
        tags = await r4.json();
        render();
    } catch (err) { console.error(err); }
}

function getTagColorStyle(color) {
    const colors = {
        accent: 'background: var(--accent-dim); color: var(--accent);',
        warning: 'background: rgba(255, 193, 7, 0.15); color: var(--warning);',
        error: 'background: rgba(255, 77, 106, 0.15); color: var(--error);',
        secondary: 'background: var(--bg-hover); color: var(--text-secondary);'
    };
    return colors[color] || colors.secondary;
}

function render() {
    document.getElementById('regionsList').innerHTML = regions.length ? regions.map(r => `
        <div class="tag-item"><span style="flex:1;">${escapeHtml(r.name)}</span>
        <button onclick="openEdit('region',${r.id})">‚úé</button>
        <button onclick="deleteItem('region',${r.id})">‚úï</button></div>
    `).join('') : '<span class="text-muted">No regions</span>';
    
    document.getElementById('tsdsList').innerHTML = tsds.length ? tsds.map(t => `
        <div class="tag-item"><span style="flex:1;">${escapeHtml(t.name)}</span>
        <button onclick="openEdit('tsd',${t.id})">‚úé</button>
        <button onclick="deleteItem('tsd',${t.id})">‚úï</button></div>
    `).join('') : '<span class="text-muted">No TSDs</span>';
    
    document.getElementById('productsList').innerHTML = products.length ? products.map(p => `
        <div class="tag-item"><span style="flex:1;">${escapeHtml(p.name)}</span>
        <button onclick="openEdit('product',${p.id})">‚úé</button>
        <button onclick="deleteItem('product',${p.id})">‚úï</button></div>
    `).join('') : '<span class="text-muted">No products</span>';
    
    document.getElementById('tagsList').innerHTML = tags.length ? tags.map(t => `
        <div class="tag-item" style="${getTagColorStyle(t.color)}"><span style="flex:1;">${escapeHtml(t.name)}</span>
        <button onclick="openEdit('tag',${t.id})">‚úé</button>
        <button onclick="deleteItem('tag',${t.id})">‚úï</button></div>
    `).join('') : '<span class="text-muted">No tags</span>';
}

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

async function addRegion() {
    const input = document.getElementById('newRegion');
    if (!input.value.trim()) return;
    await fetch('/api/regions', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name: input.value.trim()}) });
    input.value = ''; showToast('Region added'); loadData();
}

async function addTsd() {
    const input = document.getElementById('newTsd');
    if (!input.value.trim()) return;
    await fetch('/api/tsds', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name: input.value.trim()}) });
    input.value = ''; showToast('TSD added'); loadData();
}

async function addProduct() {
    const input = document.getElementById('newProduct');
    if (!input.value.trim()) return;
    await fetch('/api/products', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name: input.value.trim()}) });
    input.value = ''; showToast('Product added'); loadData();
}

async function addTag() {
    const input = document.getElementById('newTag');
    const color = document.getElementById('newTagColor').value;
    if (!input.value.trim()) return;
    await fetch('/api/tags', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name: input.value.trim(), color}) });
    input.value = ''; showToast('Tag added'); loadData();
}

async function deleteItem(type, id) {
    if (!confirm('Delete this item?')) return;
    await fetch(`/api/${type}s/${id}`, { method: 'DELETE' });
    showToast('Deleted'); loadData();
}

function openEdit(type, id) {
    const items = {region: regions, tsd: tsds, product: products, tag: tags}[type];
    const item = items.find(i => i.id === id);
    if (!item) return;
    document.getElementById('editType').value = type;
    document.getElementById('editItemId').value = id;
    document.getElementById('editName').value = item.name;
    document.getElementById('editModalTitle').textContent = 'Edit ' + type;
    document.getElementById('editColorGroup').classList.toggle('hidden', type !== 'tag');
    if (type === 'tag') document.getElementById('editColor').value = item.color || 'accent';
    openModal('editModal');
}

async function saveEdit() {
    const type = document.getElementById('editType').value;
    const id = document.getElementById('editItemId').value;
    const name = document.getElementById('editName').value.trim();
    if (!name) return;
    const body = type === 'tag' ? {name, color: document.getElementById('editColor').value} : {name};
    await fetch(`/api/${type}s/${id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
    closeModal('editModal'); showToast('Updated'); loadData();
}

// AI Knowledge
async function loadKnowledge() {
    try {
        const res = await fetch('/api/ai/knowledge');
        knowledge = await res.json();
        document.getElementById('knowledgeCount').textContent = knowledge.length;
        renderKnowledge();
        updateStepIndicators();
    } catch (err) { console.error(err); }
}

function updateStepIndicators() {
    const hasProducts = knowledge.some(k => k.category === 'products');
    const hasObjections = knowledge.some(k => k.category === 'objections');
    const hasTone = knowledge.some(k => k.category === 'tone');
    
    if (hasProducts) document.getElementById('step1Ind').classList.add('done');
    if (knowledge.length >= 3) document.getElementById('step2Ind').classList.add('done');
    if (hasObjections) document.getElementById('step3Ind').classList.add('done');
    if (hasTone) document.getElementById('step4Ind').classList.add('done');
    if (knowledge.length >= 5) document.getElementById('step5Ind').classList.add('done');
}

const categoryLabels = { products: 'üì¶ Products', objections: 'üõ°Ô∏è Objections', faq: '‚ùì FAQ', tone: 'üéØ Tone', general: 'üìã General' };

function renderKnowledge() {
    const container = document.getElementById('knowledgeList');
    if (!knowledge.length) {
        container.innerHTML = '<div class="text-center text-muted" style="padding: 20px;">No knowledge yet</div>';
        return;
    }
    const grouped = {};
    knowledge.forEach(k => { if (!grouped[k.category]) grouped[k.category] = []; grouped[k.category].push(k); });
    
    container.innerHTML = Object.entries(grouped).map(([cat, items]) => `
        <div style="margin-bottom: 16px;">
            <div style="font-weight: 600; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;">${categoryLabels[cat] || cat}</div>
            ${items.map(k => `
                <div class="tag-item mb-2">
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 500; font-size: 0.85rem;">${escapeHtml(k.title)}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(k.content.substring(0, 60))}...</div>
                    </div>
                    <button onclick="editKnowledge(${k.id})">‚úé</button>
                    <button onclick="deleteKnowledge(${k.id})">‚úï</button>
                </div>
            `).join('')}
        </div>
    `).join('');
}

async function scrapeWebsite() {
    const url = document.getElementById('scrapeUrl').value.trim();
    if (!url) { showToast('Enter a URL', 'warning'); return; }
    
    const btn = document.getElementById('scrapeBtn');
    const status = document.getElementById('scrapeStatus');
    btn.disabled = true; btn.textContent = '‚è≥...';
    status.innerHTML = '<span class="text-muted">Importing... (30-60s)</span>';
    
    try {
        const res = await fetch('/api/ai/scrape', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({url}) });
        const data = await res.json();
        if (data.error) { status.innerHTML = `<span style="color:var(--error);">‚ùå ${data.error}</span>`; }
        else { status.innerHTML = `<span style="color:var(--accent);">‚úÖ Imported ${data.added} items!</span>`; loadKnowledge(); }
    } catch (err) { status.innerHTML = '<span style="color:var(--error);">‚ùå Failed</span>'; }
    finally { btn.disabled = false; btn.textContent = 'üîç Import'; }
}

function addSuggestedObjection(text) {
    document.getElementById('objectionTitle').value = text;
    document.getElementById('objectionResponse').focus();
}

async function addObjection() {
    const title = document.getElementById('objectionTitle').value.trim();
    const content = document.getElementById('objectionResponse').value.trim();
    if (!title || !content) { showToast('Fill both fields', 'warning'); return; }
    await fetch('/api/ai/knowledge', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ category: 'objections', title: `"${title}"`, content }) });
    document.getElementById('objectionTitle').value = '';
    document.getElementById('objectionResponse').value = '';
    showToast('Objection added!'); loadKnowledge();
}

async function analyzeMyStyle() {
    const btn = document.getElementById('analyzeStyleBtn');
    const status = document.getElementById('analyzeStatus');
    btn.disabled = true; btn.textContent = '‚è≥...';
    status.innerHTML = '<span class="text-muted">Analyzing...</span>';
    
    try {
        const res = await fetch('/api/ai/analyze-style', { method: 'POST' });
        const data = await res.json();
        if (data.error) { status.innerHTML = `<span style="color:var(--error);">‚ùå ${data.error}</span>`; }
        else { status.innerHTML = `<span style="color:var(--accent);">‚úÖ Learned from ${data.messages_analyzed} messages!</span>`; document.getElementById('toneDescription').value = data.style_guide; loadKnowledge(); }
    } catch (err) { status.innerHTML = '<span style="color:var(--error);">‚ùå Failed</span>'; }
    finally { btn.disabled = false; btn.textContent = '‚ú® Analyze My Messages'; }
}

function setTonePreset(preset) {
    const presets = {
        casual: 'Keep it casual and friendly. Use first names. Be conversational. Use contractions. Short and punchy messages.',
        professional: 'Professional but warm. Proper grammar. Clear and concise. Business-appropriate.',
        consultative: 'Consultative approach. Ask questions. Position as advisor, not salesperson.'
    };
    document.getElementById('toneDescription').value = presets[preset] || '';
}

async function saveTone() {
    const content = document.getElementById('toneDescription').value.trim();
    if (!content) { showToast('Describe your style', 'warning'); return; }
    const existing = knowledge.find(k => k.category === 'tone' && k.title === 'Communication Style');
    if (existing) { await fetch(`/api/ai/knowledge/${existing.id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ category: 'tone', title: 'Communication Style', content }) }); }
    else { await fetch('/api/ai/knowledge', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ category: 'tone', title: 'Communication Style', content }) }); }
    showToast('Style saved!'); loadKnowledge();
}

async function quickAddKnowledge() {
    const category = document.getElementById('quickCategory').value;
    const title = document.getElementById('quickTitle').value.trim();
    const content = document.getElementById('quickContent').value.trim();
    if (!title || !content) { showToast('Fill all fields', 'warning'); return; }
    await fetch('/api/ai/knowledge', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ category, title, content }) });
    document.getElementById('quickTitle').value = '';
    document.getElementById('quickContent').value = '';
    showToast('Knowledge added!'); loadKnowledge();
}

function editKnowledge(id) {
    const item = knowledge.find(k => k.id === id);
    if (!item) return;
    document.getElementById('editKnowledgeId').value = id;
    document.getElementById('editKnowledgeCategory').value = item.category;
    document.getElementById('editKnowledgeTitleInput').value = item.title;
    document.getElementById('editKnowledgeContent').value = item.content;
    openModal('editKnowledgeModal');
}

async function saveKnowledge() {
    const id = document.getElementById('editKnowledgeId').value;
    const category = document.getElementById('editKnowledgeCategory').value;
    const title = document.getElementById('editKnowledgeTitleInput').value.trim();
    const content = document.getElementById('editKnowledgeContent').value.trim();
    if (!title || !content) { showToast('Fill all fields', 'warning'); return; }
    await fetch(`/api/ai/knowledge/${id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ category, title, content }) });
    closeModal('editKnowledgeModal'); showToast('Updated'); loadKnowledge();
}

async function deleteKnowledge(id) {
    if (!confirm('Delete this?')) return;
    await fetch(`/api/ai/knowledge/${id}`, { method: 'DELETE' });
    showToast('Deleted'); loadKnowledge();
}

// Calendar Link
async function loadCalendarLink() {
    try {
        const res = await fetch('/api/user/settings');
        const data = await res.json();
        if (data.calendar_link) {
            document.getElementById('calendarLink').value = data.calendar_link;
        }
    } catch (err) { console.error(err); }
}

async function saveCalendarLink() {
    const link = document.getElementById('calendarLink').value.trim();
    try {
        await fetch('/api/user/settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ calendar_link: link })
        });
        showToast('Calendar link saved!');
    } catch (err) {
        showToast('Failed to save', 'error');
    }
}

// Change Password
async function changePassword() {
    const current = document.getElementById('currentPassword').value;
    const newPw = document.getElementById('newPassword').value;
    
    if (!current || !newPw) {
        showToast('Fill in both fields', 'warning');
        return;
    }
    
    if (newPw.length < 6) {
        showToast('Password must be at least 6 characters', 'warning');
        return;
    }
    
    try {
        const res = await fetch('/api/user/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ current_password: current, new_password: newPw })
        });
        const data = await res.json();
        
        if (data.success) {
            showToast('Password updated!');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
        } else {
            showToast(data.error || 'Failed to update', 'error');
        }
    } catch (err) {
        showToast('Failed to update password', 'error');
    }
}

document.getElementById('newRegion').addEventListener('keydown', e => { if (e.key === 'Enter') addRegion(); });
document.getElementById('newTsd').addEventListener('keydown', e => { if (e.key === 'Enter') addTsd(); });
document.getElementById('newProduct').addEventListener('keydown', e => { if (e.key === 'Enter') addProduct(); });
document.getElementById('newTag').addEventListener('keydown', e => { if (e.key === 'Enter') addTag(); });

loadData();
loadKnowledge();
loadCalendarLink();
</script>
{% endblock %}
