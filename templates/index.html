{% extends 'base.html' %}
{% block title %}Dashboard - SilverSky SMS{% endblock %}

{% block content %}
<header class="header">
    <h1>
        <div class="logo-mark">S</div>
        SilverSky
    </h1>
</header>

<main class="content">
    <!-- Onboarding Banner -->
    {% if not onboarding_complete %}
    <div id="onboardingBanner" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: var(--radius-lg); padding: 16px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 4px;">âœ¨ Complete your setup</div>
            <div style="font-size: 0.8rem; color: var(--text-secondary);">Step {{ onboarding_step }} of 6 - Get the most out of AI features</div>
        </div>
        <a href="/onboarding" class="btn btn-sm btn-ai" style="text-decoration: none;">Continue â†’</a>
    </div>
    {% endif %}
    
    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="totalPartners">-</div>
            <div class="stat-label">Contacts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="unreadCount">-</div>
            <div class="stat-label">Unread</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="sentWeek">-</div>
            <div class="stat-label">Sent (7d)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="responseRate">-</div>
            <div class="stat-label">Response %</div>
        </div>
    </div>
    
    <!-- AI Insights -->
    <div class="card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%); border-color: rgba(102, 126, 234, 0.25);">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <div style="font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.1rem;">âœ¨</span> AI Insights
            </div>
            <button class="btn btn-sm btn-ghost" onclick="loadNextActions()" id="refreshActionsBtn" style="padding: 6px 10px; font-size: 0.7rem;">Refresh</button>
        </div>
        <div id="nextActionsList">
            <div style="text-align: center; padding: 16px;">
                <button class="btn btn-sm btn-ai" onclick="loadNextActions()">Load Recommendations</button>
            </div>
        </div>
    </div>
    
    <!-- Ghost Alerts -->
    <div class="card">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <div style="font-weight: 600; font-size: 0.9rem;">ðŸ‘» Ghost Alerts</div>
        </div>
        <div id="ghostAlertsList">
            <div style="text-align: center; padding: 16px;">
                <button class="btn btn-sm btn-secondary" onclick="loadGhostAlerts()">Check for Ghosts</button>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="section-title">Quick Actions</div>
    <div class="flex gap-2 mb-3">
        <a href="/broadcast" class="btn btn-block">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
            </svg>
            Send Broadcast
        </a>
    </div>
    <div class="flex gap-2">
        <a href="/partners" class="btn btn-secondary btn-block">+ Add Contact</a>
        <a href="/inbox" class="btn btn-secondary btn-block">View Inbox</a>
    </div>
    
    <!-- Recent Conversations -->
    <div class="section-title">Recent Conversations</div>
    <div id="recentConvos">
        <div class="loading"><div class="spinner"></div></div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
async function loadDashboard() {
    try {
        const statsRes = await fetch('/api/stats');
        const stats = await statsRes.json();
        
        document.getElementById('totalPartners').textContent = stats.total_partners;
        document.getElementById('unreadCount').textContent = stats.unread;
        document.getElementById('sentWeek').textContent = stats.sent_week;
        document.getElementById('responseRate').textContent = stats.response_rate + '%';
        
        const convosRes = await fetch('/api/conversations');
        const convos = await convosRes.json();
        renderConvos(convos.slice(0, 5));
    } catch (err) {
        console.error(err);
    }
}

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function renderConvos(convos) {
    const container = document.getElementById('recentConvos');
    
    if (convos.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                </svg>
                <h3>No conversations yet</h3>
                <p>Start by adding contacts and sending messages</p>
                <a href="/partners" class="btn btn-sm">Add Your First Contact</a>
            </div>
        `;
        return;
    }
    
    container.innerHTML = convos.map(c => `
        <div class="convo-item" onclick="location.href='/inbox?partner=${c.partner_id}'">
            <div class="convo-avatar">${getInitials(c.name)}</div>
            <div class="convo-content">
                <div class="convo-name">${escapeHtml(c.name)}</div>
                <div class="convo-preview">${escapeHtml(c.latest_message || 'No messages')}</div>
            </div>
            <div class="convo-meta">
                <div class="convo-time">${formatTime(c.latest_time)}</div>
                ${c.unread > 0 ? `<div class="convo-badge">${c.unread}</div>` : ''}
            </div>
        </div>
    `).join('');
}

function getInitials(name) {
    return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
}

function formatTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    const now = new Date();
    const diff = now - d;
    if (diff < 60000) return 'Now';
    if (diff < 3600000) return Math.floor(diff/60000) + 'm';
    if (diff < 86400000) return Math.floor(diff/3600000) + 'h';
    return d.toLocaleDateString();
}

async function loadNextActions() {
    const container = document.getElementById('nextActionsList');
    const btn = document.getElementById('refreshActionsBtn');
    
    container.innerHTML = '<div style="text-align: center; padding: 16px;"><div class="spinner"></div></div>';
    btn.disabled = true;
    
    try {
        const res = await fetch('/api/ai/next-actions');
        const actions = await res.json();
        
        if (actions.error) {
            container.innerHTML = `<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 0.85rem;">${actions.error}</div>`;
            return;
        }
        
        if (actions.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--accent); font-size: 0.85rem;">âœ“ All caught up!</div>';
            return;
        }
        
        const priorityColors = { high: 'var(--error)', medium: 'var(--warning)', low: 'var(--text-muted)' };
        
        container.innerHTML = actions.slice(0, 3).map(a => `
            <div style="background: var(--bg-hover); border-radius: var(--radius-md); padding: 12px; margin-bottom: 8px; cursor: pointer;" onclick="handleAction(${a.partner_id}, '${escapeHtml(a.suggested_message || '')}')">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <span style="font-weight: 600; font-size: 0.9rem;">${escapeHtml(a.partner_name || 'Unknown')}</span>
                    <span class="chip" style="background: ${priorityColors[a.priority]}22; color: ${priorityColors[a.priority]}; font-size: 0.65rem;">${a.priority}</span>
                </div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px;">ðŸ’¡ ${escapeHtml(a.reason)}</div>
                <div style="font-size: 0.85rem; color: var(--accent);">"${escapeHtml(a.suggested_message || '')}"</div>
            </div>
        `).join('');
    } catch (err) {
        container.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--error);">Failed to load</div>';
    } finally {
        btn.disabled = false;
    }
}

async function loadGhostAlerts() {
    const container = document.getElementById('ghostAlertsList');
    container.innerHTML = '<div style="text-align: center; padding: 16px;"><div class="spinner"></div></div>';
    
    try {
        const res = await fetch('/api/ai/ghost-alerts');
        const ghosts = await res.json();
        
        if (ghosts.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--accent); font-size: 0.85rem;">âœ“ No ghosts - everyone engaged!</div>';
            return;
        }
        
        container.innerHTML = ghosts.slice(0, 3).map(g => `
            <div style="background: var(--bg-hover); border-radius: var(--radius-md); padding: 12px; margin-bottom: 8px; border-left: 3px solid ${g.urgency === 'high' ? 'var(--error)' : 'var(--warning)'}; cursor: pointer;" onclick="handleAction(${g.partner_id}, '${escapeHtml(g.suggested_message || '')}')">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="font-weight: 600; font-size: 0.9rem;">${escapeHtml(g.name)}</span>
                    <span style="font-size: 0.75rem; color: var(--error);">${g.days_waiting}d silent</span>
                </div>
                ${g.suggested_message ? `<div style="font-size: 0.85rem; color: var(--accent);">"${escapeHtml(g.suggested_message)}"</div>` : ''}
            </div>
        `).join('');
    } catch (err) {
        container.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--error);">Failed to load</div>';
    }
}

function handleAction(partnerId, message) {
    const url = `/inbox?partner=${partnerId}${message ? '&msg=' + encodeURIComponent(message) : ''}`;
    location.href = url;
}

loadDashboard();
</script>
{% endblock %}
