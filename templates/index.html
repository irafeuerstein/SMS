{% extends 'base.html' %}
{% block title %}Dashboard - SilverSky Partners{% endblock %}

{% block content %}
<header class="header">
    <h1>SilverSky Partners</h1>
</header>

<main class="content">
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="stat-value" id="totalPartners">-</div>
            <div class="stat-label">Total Partners</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="newPartners">-</div>
            <div class="stat-label">Never Contacted</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="recentMessages">-</div>
            <div class="stat-label">Messages Today</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="unreadCount">-</div>
            <div class="stat-label">Unread Replies</div>
        </div>
    </div>
    
    <h2 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 12px;">Quick Actions</h2>
    
    <div class="flex gap-2 mb-3">
        <a href="/broadcast" class="btn btn-block">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
            </svg>
            Send Broadcast
        </a>
    </div>
    
    <div class="flex gap-2">
        <a href="/partners" class="btn btn-secondary btn-block">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
            </svg>
            Add Partner
        </a>
        <a href="/inbox" class="btn btn-secondary btn-block">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
            </svg>
            View Inbox
        </a>
    </div>
    
    <h2 style="font-size: 0.9rem; color: var(--text-secondary); margin: 20px 0 12px;">Recent Conversations</h2>
    
    <div id="recentConvos">
        <div class="loading"><div class="spinner"></div></div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
async function loadDashboard() {
    try {
        // Load partners for stats
        const partnersRes = await fetch('/api/partners');
        const partners = await partnersRes.json();
        
        document.getElementById('totalPartners').textContent = partners.length;
        document.getElementById('newPartners').textContent = partners.filter(p => p.is_new).length;
        
        // Load conversations
        const convosRes = await fetch('/api/conversations');
        const convos = await convosRes.json();
        
        const unread = convos.reduce((sum, c) => sum + c.unread, 0);
        document.getElementById('unreadCount').textContent = unread;
        
        // Count today's messages (approximate)
        const today = new Date().toISOString().split('T')[0];
        const todayConvos = convos.filter(c => c.latest_time && c.latest_time.startsWith(today));
        document.getElementById('recentMessages').textContent = todayConvos.length;
        
        // Render recent convos
        renderConvos(convos.slice(0, 5));
    } catch (err) {
        console.error(err);
    }
}

function renderConvos(convos) {
    const container = document.getElementById('recentConvos');
    
    if (convos.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <p>No conversations yet</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = convos.map(c => `
        <div class="convo-item" onclick="location.href='/inbox?partner=${c.partner_id}'">
            <div class="convo-avatar">${getInitials(c.name)}</div>
            <div class="convo-content">
                <div class="convo-name">${c.name}</div>
                <div class="convo-preview">${c.latest_message || 'No messages'}</div>
            </div>
            <div class="convo-meta">
                <div class="convo-time">${formatTime(c.latest_time)}</div>
                ${c.unread > 0 ? `<div class="convo-badge">${c.unread}</div>` : ''}
            </div>
        </div>
    `).join('');
}

function getInitials(name) {
    return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
}

function formatTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    const now = new Date();
    const diff = now - d;
    
    if (diff < 60000) return 'Now';
    if (diff < 3600000) return Math.floor(diff/60000) + 'm';
    if (diff < 86400000) return Math.floor(diff/3600000) + 'h';
    return d.toLocaleDateString();
}

loadDashboard();
</script>
{% endblock %}
