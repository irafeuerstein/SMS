{% extends 'base.html' %}
{% block title %}Partners - SilverSky Partners{% endblock %}

{% block content %}
<header class="header">
    <h1>Partners</h1>
    <button class="header-btn" onclick="openModal('addModal')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
    </button>
</header>

<main class="content">
    <!-- Filters -->
    <div class="filter-bar" id="filterBar">
        <button class="filter-chip" onclick="toggleFilter('new')" id="filterNew">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
            New Only
        </button>
        <button class="filter-chip" onclick="openFilterModal('region')">
            Region <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </button>
        <button class="filter-chip" onclick="openFilterModal('tsd')">
            TSD <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </button>
        <button class="filter-chip" onclick="openFilterModal('product')">
            Product <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </button>
    </div>
    
    <div id="activeFilters" class="chips mb-3" style="display: none;"></div>
    
    <div id="partnerCount" style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;"></div>
    
    <div id="partnersList">
        <div class="loading"><div class="spinner"></div></div>
    </div>
</main>

<!-- Add Partner Modal -->
<div class="modal-overlay" id="addModal">
    <div class="modal">
        <div class="modal-handle"></div>
        <h2 class="modal-title">Add Partner</h2>
        
        <form id="addForm" onsubmit="addPartner(event)">
            <div class="flex gap-2">
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-input" id="firstName" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-input" id="lastName">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Company</label>
                <input type="text" class="form-input" id="company">
            </div>
            
            <div class="form-group">
                <label class="form-label">Phone (with country code)</label>
                <input type="tel" class="form-input" id="phone" placeholder="+1..." required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Region</label>
                <select class="form-select" id="regionId">
                    <option value="">Select region...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">TSD</label>
                <select class="form-select" id="tsdId">
                    <option value="">Select TSD...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Products</label>
                <div class="checkbox-group" id="productCheckboxes"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" id="notes" rows="2"></textarea>
            </div>
            
            <div class="flex gap-2 mt-4">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addModal')" style="flex: 1;">Cancel</button>
                <button type="submit" class="btn" style="flex: 1;">Add Partner</button>
            </div>
        </form>
    </div>
</div>

<!-- View/Edit Partner Modal -->
<div class="modal-overlay" id="viewModal">
    <div class="modal">
        <div class="modal-handle"></div>
        <div id="viewContent"></div>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal-overlay" id="filterModal">
    <div class="modal">
        <div class="modal-handle"></div>
        <h2 class="modal-title" id="filterModalTitle">Filter</h2>
        <div id="filterOptions"></div>
        <div class="flex gap-2 mt-4">
            <button class="btn btn-secondary" onclick="closeModal('filterModal')" style="flex: 1;">Cancel</button>
            <button class="btn" onclick="applyFilter()" style="flex: 1;">Apply</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let partners = [];
let regions = [];
let tsds = [];
let products = [];
let activeFilters = {
    new_only: false,
    region_ids: [],
    tsd_ids: [],
    product_ids: []
};
let currentFilterType = null;

async function loadData() {
    try {
        const [regRes, tsdRes, prodRes] = await Promise.all([
            fetch('/api/regions'),
            fetch('/api/tsds'),
            fetch('/api/products')
        ]);
        
        regions = await regRes.json();
        tsds = await tsdRes.json();
        products = await prodRes.json();
        
        populateDropdowns();
        loadPartners();
    } catch (err) {
        console.error(err);
    }
}

function populateDropdowns() {
    const regionSelect = document.getElementById('regionId');
    regionSelect.innerHTML = '<option value="">Select region...</option>' + 
        regions.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
    
    const tsdSelect = document.getElementById('tsdId');
    tsdSelect.innerHTML = '<option value="">Select TSD...</option>' + 
        tsds.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    
    const prodContainer = document.getElementById('productCheckboxes');
    prodContainer.innerHTML = products.map(p => `
        <label class="checkbox-item">
            <input type="checkbox" value="${p.id}">
            <span>${p.name}</span>
        </label>
    `).join('');
}

async function loadPartners() {
    let url = '/api/partners?';
    
    if (activeFilters.new_only) url += 'new_only=true&';
    activeFilters.region_ids.forEach(id => url += `region_id=${id}&`);
    activeFilters.tsd_ids.forEach(id => url += `tsd_id=${id}&`);
    activeFilters.product_ids.forEach(id => url += `product_id=${id}&`);
    
    try {
        const res = await fetch(url);
        partners = await res.json();
        renderPartners();
        renderActiveFilters();
    } catch (err) {
        console.error(err);
    }
}

function renderPartners() {
    const container = document.getElementById('partnersList');
    document.getElementById('partnerCount').textContent = `${partners.length} partner${partners.length !== 1 ? 's' : ''}`;
    
    if (partners.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <h3>No partners found</h3>
                <p>Add a partner or adjust your filters</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = partners.map(p => `
        <div class="card" onclick="viewPartner(${p.id})">
            <div class="card-header">
                <div>
                    <div class="card-title">${p.full_name}</div>
                    <div class="card-subtitle">${p.company || 'No company'}</div>
                </div>
                ${p.is_new ? '<span class="chip new">New</span>' : ''}
            </div>
            <div class="chips">
                ${p.region ? `<span class="chip">${p.region}</span>` : ''}
                ${p.tsd ? `<span class="chip">${p.tsd}</span>` : ''}
                ${p.products.map(prod => `<span class="chip accent">${prod.name}</span>`).join('')}
            </div>
        </div>
    `).join('');
}

function renderActiveFilters() {
    const container = document.getElementById('activeFilters');
    const chips = [];
    
    if (activeFilters.new_only) chips.push({ type: 'new', label: 'New Only' });
    
    activeFilters.region_ids.forEach(id => {
        const region = regions.find(r => r.id == id);
        if (region) chips.push({ type: 'region', id, label: region.name });
    });
    
    activeFilters.tsd_ids.forEach(id => {
        const tsd = tsds.find(t => t.id == id);
        if (tsd) chips.push({ type: 'tsd', id, label: tsd.name });
    });
    
    activeFilters.product_ids.forEach(id => {
        const prod = products.find(p => p.id == id);
        if (prod) chips.push({ type: 'product', id, label: prod.name });
    });
    
    if (chips.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'flex';
    container.innerHTML = chips.map(c => `
        <span class="chip accent" style="cursor: pointer;" onclick="removeFilter('${c.type}', ${c.id || 0})">
            ${c.label} âœ•
        </span>
    `).join('');
}

function toggleFilter(type) {
    if (type === 'new') {
        activeFilters.new_only = !activeFilters.new_only;
        document.getElementById('filterNew').classList.toggle('active', activeFilters.new_only);
        loadPartners();
    }
}

function openFilterModal(type) {
    currentFilterType = type;
    const title = document.getElementById('filterModalTitle');
    const options = document.getElementById('filterOptions');
    
    let items = [];
    let selectedIds = [];
    
    if (type === 'region') {
        title.textContent = 'Select Regions';
        items = regions;
        selectedIds = activeFilters.region_ids;
    } else if (type === 'tsd') {
        title.textContent = 'Select TSDs';
        items = tsds;
        selectedIds = activeFilters.tsd_ids;
    } else if (type === 'product') {
        title.textContent = 'Select Products';
        items = products;
        selectedIds = activeFilters.product_ids;
    }
    
    options.innerHTML = items.map(item => `
        <label class="checkbox-item" style="width: 100%; margin-bottom: 8px;">
            <input type="checkbox" value="${item.id}" ${selectedIds.includes(item.id) ? 'checked' : ''}>
            <span>${item.name}</span>
        </label>
    `).join('');
    
    openModal('filterModal');
}

function applyFilter() {
    const checkboxes = document.querySelectorAll('#filterOptions input:checked');
    const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    if (currentFilterType === 'region') {
        activeFilters.region_ids = ids;
    } else if (currentFilterType === 'tsd') {
        activeFilters.tsd_ids = ids;
    } else if (currentFilterType === 'product') {
        activeFilters.product_ids = ids;
    }
    
    closeModal('filterModal');
    loadPartners();
}

function removeFilter(type, id) {
    if (type === 'new') {
        activeFilters.new_only = false;
        document.getElementById('filterNew').classList.remove('active');
    } else if (type === 'region') {
        activeFilters.region_ids = activeFilters.region_ids.filter(i => i !== id);
    } else if (type === 'tsd') {
        activeFilters.tsd_ids = activeFilters.tsd_ids.filter(i => i !== id);
    } else if (type === 'product') {
        activeFilters.product_ids = activeFilters.product_ids.filter(i => i !== id);
    }
    loadPartners();
}

async function addPartner(e) {
    e.preventDefault();
    
    const productCheckboxes = document.querySelectorAll('#productCheckboxes input:checked');
    const productIds = Array.from(productCheckboxes).map(cb => parseInt(cb.value));
    
    const data = {
        first_name: document.getElementById('firstName').value,
        last_name: document.getElementById('lastName').value,
        company: document.getElementById('company').value,
        phone: document.getElementById('phone').value,
        region_id: document.getElementById('regionId').value || null,
        tsd_id: document.getElementById('tsdId').value || null,
        product_ids: productIds,
        notes: document.getElementById('notes').value
    };
    
    try {
        const res = await fetch('/api/partners', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (res.ok) {
            closeModal('addModal');
            document.getElementById('addForm').reset();
            loadPartners();
        } else {
            const err = await res.json();
            alert(err.error || 'Failed to add partner');
        }
    } catch (err) {
        console.error(err);
        alert('Failed to add partner');
    }
}

function viewPartner(id) {
    const partner = partners.find(p => p.id === id);
    if (!partner) return;
    
    const content = document.getElementById('viewContent');
    content.innerHTML = `
        <h2 class="modal-title">${partner.full_name}</h2>
        <p class="card-subtitle" style="margin-bottom: 16px;">${partner.company || 'No company'}</p>
        
        <div class="form-group">
            <label class="form-label">Phone</label>
            <div style="font-size: 1rem;">${partner.phone}</div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Region</label>
            <div style="font-size: 1rem;">${partner.region || 'Not set'}</div>
        </div>
        
        <div class="form-group">
            <label class="form-label">TSD</label>
            <div style="font-size: 1rem;">${partner.tsd || 'Not set'}</div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Products</label>
            <div class="chips">
                ${partner.products.length > 0 ? partner.products.map(p => `<span class="chip accent">${p.name}</span>`).join('') : '<span class="text-muted">None</span>'}
            </div>
        </div>
        
        ${partner.notes ? `
        <div class="form-group">
            <label class="form-label">Notes</label>
            <div style="font-size: 0.9rem; color: var(--text-secondary);">${partner.notes}</div>
        </div>
        ` : ''}
        
        <div class="form-group">
            <label class="form-label">Status</label>
            <div>${partner.is_new ? '<span class="chip new">Never contacted</span>' : `Last contacted: ${new Date(partner.last_contacted).toLocaleDateString()}`}</div>
        </div>
        
        <div class="flex gap-2 mt-4">
            <button class="btn" onclick="messagePartner(${partner.id})" style="flex: 1;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                </svg>
                Message
            </button>
            <button class="btn btn-secondary" onclick="deletePartner(${partner.id})">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
            </button>
        </div>
    `;
    
    openModal('viewModal');
}

function messagePartner(id) {
    closeModal('viewModal');
    location.href = `/inbox?partner=${id}`;
}

async function deletePartner(id) {
    if (!confirm('Delete this partner?')) return;
    
    try {
        await fetch(`/api/partners/${id}`, { method: 'DELETE' });
        closeModal('viewModal');
        loadPartners();
    } catch (err) {
        console.error(err);
    }
}

function openModal(id) {
    document.getElementById(id).classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', e => {
        if (e.target === overlay) overlay.classList.remove('active');
    });
});

loadData();
</script>
{% endblock %}
