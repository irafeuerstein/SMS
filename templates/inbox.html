{% extends 'base.html' %}
{% block title %}Inbox - SilverSky Partners{% endblock %}

{% block extra_css %}
<style>
    .chat-header {
        background: var(--bg-card);
        border-bottom: 1px solid var(--border);
        padding: 12px 16px;
        margin: -16px -16px 16px -16px;
    }
    .chat-header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .chat-header-name {
        font-weight: 600;
        font-size: 1rem;
    }
    .chat-header-company {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    .chat-header-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
    }
    .chat-actions {
        display: flex;
        gap: 4px;
    }
    .chat-action-btn {
        background: var(--bg-hover);
        border: none;
        color: var(--text-secondary);
        width: 32px;
        height: 32px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
    }
    .chat-action-btn:hover {
        color: var(--accent);
    }
    .chat-action-btn.active {
        color: var(--accent);
        background: rgba(0, 212, 170, 0.15);
    }
    .filter-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        overflow-x: auto;
        padding-bottom: 4px;
    }
    .filter-tab {
        background: var(--bg-card);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        cursor: pointer;
        white-space: nowrap;
    }
    .filter-tab.active {
        background: var(--accent);
        color: var(--bg-dark);
        border-color: var(--accent);
    }
    .convo-item.pinned {
        border-left: 3px solid var(--accent);
    }
    .pin-icon {
        color: var(--accent);
        font-size: 0.7rem;
        margin-left: 4px;
    }
    .notes-section {
        background: var(--bg-dark);
        border-radius: 8px;
        padding: 10px;
        margin-top: 8px;
    }
    .notes-textarea {
        width: 100%;
        background: transparent;
        border: none;
        color: var(--text-primary);
        font-size: 0.8rem;
        resize: none;
        outline: none;
    }
    .new-messages-btn {
        position: fixed;
        bottom: 180px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--accent);
        color: var(--bg-dark);
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        display: none;
        z-index: 50;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .message-status {
        font-size: 0.7rem;
        margin-left: 4px;
    }
    .unread-badge-large {
        background: var(--accent);
        color: var(--bg-dark);
        font-size: 0.7rem;
        font-weight: 700;
        padding: 3px 8px;
        border-radius: 10px;
        min-width: 22px;
        text-align: center;
    }
    .ai-suggestions {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 8px;
        padding: 8px;
        background: var(--bg-dark);
        border-radius: 8px;
        border: 1px solid rgba(0, 212, 170, 0.3);
    }
    .ai-suggestions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }
    .ai-suggestions-title {
        font-size: 0.7rem;
        color: var(--accent);
        font-weight: 600;
    }
    .ai-suggestion-btn {
        background: var(--bg-card);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
        text-align: left;
        cursor: pointer;
        transition: all 0.2s;
    }
    .ai-suggestion-btn:hover {
        border-color: var(--accent);
        background: var(--bg-hover);
    }
    .ai-compose-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
    }
    .ai-compose-input {
        flex: 1;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 12px;
        color: var(--text-primary);
        font-size: 0.8rem;
    }
    .ai-compose-input:focus {
        outline: none;
        border-color: var(--accent);
    }
    .ai-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
    }
    .ai-btn:disabled {
        opacity: 0.5;
    }
    .sentiment-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.65rem;
        font-weight: 600;
    }
    .sentiment-positive { background: rgba(0, 212, 170, 0.2); color: var(--accent); }
    .sentiment-neutral { background: rgba(255, 187, 0, 0.2); color: var(--warning); }
    .sentiment-negative { background: rgba(255, 85, 102, 0.2); color: var(--error); }
</style>
{% endblock %}

{% block content %}
<header class="header">
    <button class="header-btn hidden" id="backBtn" onclick="showConversations()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
    </button>
    <h1 id="headerTitle">Inbox</h1>
    <div style="display: flex; gap: 4px;">
        <button class="header-btn" id="filterBtn" onclick="openModal('filterModal')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
            </svg>
        </button>
        <button class="header-btn" id="searchBtn" onclick="openModal('searchModal')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
        </button>
    </div>
</header>

<main class="content" id="conversationsView">
    <!-- Filter Tabs -->
    <div class="filter-tabs">
        <button class="filter-tab active" onclick="setFilter('all')">All</button>
        <button class="filter-tab" onclick="setFilter('unread')">Unread</button>
        <button class="filter-tab" onclick="setFilter('media')">Has Media</button>
        <button class="filter-tab" onclick="setFilter('archived')">Archived</button>
    </div>
    <div id="conversationsList">
        <div class="loading"><div class="spinner"></div></div>
    </div>
</main>

<main class="content hidden" id="chatView" style="padding-bottom: 180px;">
    <!-- Chat Header with Partner Info -->
    <div class="chat-header" id="chatHeader"></div>
    
    <div class="message-list" id="messageList"></div>
    
    <button class="new-messages-btn" id="newMessagesBtn" onclick="scrollToBottom()">‚Üì New messages</button>
</main>

<div class="compose-bar hidden" id="composeBar">
    <div class="compose-bar-inner">
        <div style="flex: 1;">
            <!-- AI Suggestions -->
            <div class="ai-suggestions hidden" id="aiSuggestions">
                <div class="ai-suggestions-header">
                    <span class="ai-suggestions-title">‚ú® AI Suggestions</span>
                    <button onclick="hideAiSuggestions()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;">‚úï</button>
                </div>
                <div id="aiSuggestionsList"></div>
            </div>
            
            <!-- AI Compose -->
            <div class="ai-compose-bar">
                <input type="text" class="ai-compose-input" id="aiComposeInput" placeholder="Ask AI to write... (e.g., 'follow up about MxDR pricing')" onkeydown="if(event.key==='Enter')generateAiMessage()">
                <button class="ai-btn" onclick="generateAiMessage()" id="aiComposeBtn">‚ú® Write</button>
                <button class="ai-btn" onclick="getAiSuggestions()" id="aiSuggestBtn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">üí° Suggest</button>
            </div>
            
            <!-- Quick Replies -->
            <div class="quick-replies" id="quickReplies">
                <button class="quick-reply" onclick="insertQuickReply('Thanks!')">Thanks!</button>
                <button class="quick-reply" onclick="insertQuickReply('Let me check on that')">Let me check</button>
                <button class="quick-reply" onclick="insertQuickReply('Can we schedule a call?')">Schedule call?</button>
                <button class="quick-reply" onclick="insertInboxVariable('first_name')" style="color: var(--accent);">+ Name</button>
            </div>
            <div id="mediaPreviewContainer"></div>
            <div id="charCountInbox" style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px; text-align: right;"></div>
            <div style="display: flex; gap: 8px; align-items: flex-end;">
                <button class="compose-btn" onclick="document.getElementById('mediaInput').click()" title="Attach file">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                    </svg>
                </button>
                <button class="compose-btn" onclick="startRecording('audio')" title="Voice memo">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                </button>
                <button class="compose-btn" onclick="startRecording('video')" title="Video message">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                </button>
                <textarea class="compose-input" id="messageInput" placeholder="Type a message..." rows="1" oninput="updateCharCountInbox()" onkeydown="handleKeydown(event)"></textarea>
                <button class="compose-btn send" onclick="sendMessage()" id="sendMsgBtn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <input type="file" id="mediaInput" accept="image/*,video/*,audio/*" style="display: none;" onchange="handleMediaSelect(event)">
</div>

<!-- Recording Modal -->
<div class="modal-overlay" id="recordModal">
    <div class="modal" style="text-align: center;">
        <div class="modal-handle"></div>
        <h2 class="modal-title" id="recordTitle">Recording...</h2>
        <div id="recordingIndicator" style="font-size: 3rem; margin: 20px 0;">üî¥</div>
        <div id="recordTimer" style="font-size: 1.5rem; color: var(--accent); margin-bottom: 20px;">0:00</div>
        <video id="videoPreview" style="width: 100%; max-height: 200px; display: none; border-radius: 10px; margin-bottom: 16px;" muted playsinline></video>
        <div class="flex gap-2">
            <button class="btn btn-secondary" onclick="cancelRecording()" style="flex: 1;">Cancel</button>
            <button class="btn" onclick="stopRecording()" style="flex: 1;">Stop & Attach</button>
        </div>
    </div>
</div>

<!-- Search Modal -->
<div class="modal-overlay" id="searchModal">
    <div class="modal">
        <div class="modal-handle"></div>
        <h2 class="modal-title">Search Messages</h2>
        <div class="form-group">
            <input type="text" class="form-input" id="searchInput" placeholder="Search messages..." oninput="debounceSearch()">
        </div>
        <div id="searchResults" style="max-height: 300px; overflow-y: auto;"></div>
        <button class="btn btn-secondary btn-block mt-4" onclick="closeModal('searchModal')">Close</button>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal-overlay" id="filterModal">
    <div class="modal">
        <div class="modal-handle"></div>
        <h2 class="modal-title">Filter Conversations</h2>
        <div class="form-group">
            <label class="checkbox-item">
                <input type="checkbox" id="filterUnread" onchange="applyFilters()">
                <span>Unread only</span>
            </label>
        </div>
        <div class="form-group">
            <label class="checkbox-item">
                <input type="checkbox" id="filterHasMedia" onchange="applyFilters()">
                <span>Has media</span>
            </label>
        </div>
        <div class="form-group">
            <label class="checkbox-item">
                <input type="checkbox" id="filterArchived" onchange="applyFilters()">
                <span>Show archived</span>
            </label>
        </div>
        <button class="btn btn-block mt-4" onclick="closeModal('filterModal')">Apply</button>
    </div>
</div>

<!-- Partner Actions Modal -->
<div class="modal-overlay" id="partnerActionsModal">
    <div class="modal">
        <div class="modal-handle"></div>
        <h2 class="modal-title" id="partnerActionsTitle">Actions</h2>
        <div class="settings-list" style="margin-bottom: 16px;">
            <div class="settings-item" onclick="togglePin()" style="cursor: pointer;">
                <span class="settings-item-label" id="pinLabel">üìå Pin conversation</span>
            </div>
            <div class="settings-item" onclick="toggleArchive()" style="cursor: pointer;">
                <span class="settings-item-label" id="archiveLabel">üì¶ Archive</span>
            </div>
            <div class="settings-item" onclick="exportConversation()" style="cursor: pointer;">
                <span class="settings-item-label">üìÑ Export chat</span>
            </div>
            <div class="settings-item" onclick="editPartnerFromChat()" style="cursor: pointer;">
                <span class="settings-item-label">‚úèÔ∏è Edit partner</span>
            </div>
            <a href="" id="callLink" class="settings-item" style="text-decoration: none; color: inherit;">
                <span class="settings-item-label">üìû Call</span>
            </a>
        </div>
        <button class="btn btn-secondary btn-block" onclick="closeModal('partnerActionsModal')">Cancel</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let conversations = [];
let currentPartnerId = null;
let currentPartner = null;
let pendingMedia = null;
let mediaRecorder = null;
let recordedChunks = [];
let recordingTimer = null;
let recordingSeconds = 0;
let mediaStream = null;
let currentFilter = 'all';
let currentRecordingType = null;

// Filters
function setFilter(filter) {
    currentFilter = filter;
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    loadConversations();
}

function applyFilters() {
    loadConversations();
    closeModal('filterModal');
}

function updateCharCountInbox() {
    const text = document.getElementById('messageInput').value;
    const len = text.length;
    const segments = Math.ceil(len / 160) || 1;
    const el = document.getElementById('charCountInbox');
    
    if (len === 0) {
        el.textContent = '';
    } else {
        el.textContent = `${len}/160 (${segments} segment${segments > 1 ? 's' : ''})`;
        el.style.color = len > 160 ? 'var(--warning)' : 'var(--text-muted)';
    }
}

function insertQuickReply(text) {
    const input = document.getElementById('messageInput');
    input.value = text;
    input.focus();
    updateCharCountInbox();
}

function insertInboxVariable(varName) {
    const variable = String.fromCharCode(123, 123) + varName + String.fromCharCode(125, 125);
    const input = document.getElementById('messageInput');
    const start = input.selectionStart;
    const end = input.selectionEnd;
    const text = input.value;
    input.value = text.substring(0, start) + variable + text.substring(end);
    input.focus();
    input.selectionStart = input.selectionEnd = start + variable.length;
    updateCharCountInbox();
}

async function loadConversations() {
    try {
        let url = '/api/conversations?';
        
        if (currentFilter === 'archived') {
            url += 'archived=true&';
        } else if (currentFilter === 'unread') {
            url += 'unread=true&';
        } else if (currentFilter === 'media') {
            url += 'has_media=true&';
        }
        
        const res = await fetch(url);
        conversations = await res.json();
        renderConversations();
        
        const params = new URLSearchParams(location.search);
        const partnerId = params.get('partner');
        const prefillMsg = params.get('msg');
        
        if (partnerId) {
            openConversation(parseInt(partnerId));
            // Prefill message if provided
            if (prefillMsg) {
                setTimeout(() => {
                    document.getElementById('messageInput').value = prefillMsg;
                    updateCharCountInbox();
                }, 300);
            }
        }
    } catch (err) {
        console.error(err);
    }
}

function renderConversations() {
    const container = document.getElementById('conversationsList');
    
    if (conversations.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                </svg>
                <h3>${currentFilter === 'archived' ? 'No archived conversations' : 'No conversations yet'}</h3>
                <p>Start by messaging a partner</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = conversations.map(c => `
        <div class="convo-item ${c.pinned ? 'pinned' : ''}" onclick="openConversation(${c.partner_id})">
            <div class="convo-avatar">${getInitials(c.name)}</div>
            <div class="convo-content">
                <div class="convo-name">
                    ${escapeHtml(c.name)}
                    ${c.pinned ? '<span class="pin-icon">üìå</span>' : ''}
                    ${c.opted_out ? '<span style="color: var(--error); font-size: 0.65rem; margin-left: 4px;">OPTED OUT</span>' : ''}
                </div>
                <div class="convo-preview">
                    ${c.direction === 'inbound' ? '‚Üê ' : '‚Üí '}
                    ${c.has_media && !c.latest_message ? '[Media]' : escapeHtml(c.latest_message || '')}
                </div>
            </div>
            <div class="convo-meta">
                <div class="convo-time">${formatTime(c.latest_time)}</div>
                ${c.unread > 0 ? `<div class="unread-badge-large">${c.unread}</div>` : ''}
            </div>
        </div>
    `).join('');
}

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

async function openConversation(partnerId) {
    currentPartnerId = partnerId;
    currentPartner = conversations.find(c => c.partner_id === partnerId);
    
    if (!currentPartner) {
        // Fetch partner details if not in conversations list
        const res = await fetch(`/api/partners/${partnerId}`);
        currentPartner = await res.json();
    }
    
    document.getElementById('conversationsView').classList.add('hidden');
    document.getElementById('chatView').classList.remove('hidden');
    document.getElementById('composeBar').classList.remove('hidden');
    document.getElementById('backBtn').classList.remove('hidden');
    document.getElementById('filterBtn').classList.add('hidden');
    document.getElementById('searchBtn').classList.add('hidden');
    document.getElementById('headerTitle').textContent = currentPartner.name || currentPartner.full_name;
    
    // Handle opted out
    if (currentPartner.opted_out) {
        document.getElementById('composeBar').innerHTML = `
            <div style="text-align: center; padding: 16px; color: var(--error);">
                ‚ö†Ô∏è This partner has opted out of messages
            </div>
        `;
    }
    
    renderChatHeader();
    loadMessages();
    
    history.replaceState(null, '', `/inbox?partner=${partnerId}`);
}

function renderChatHeader() {
    const p = currentPartner;
    const tagsHtml = (p.tags || []).map(t => {
        const colors = {
            accent: 'background: rgba(0, 212, 170, 0.15); color: var(--accent);',
            warning: 'background: rgba(255, 187, 0, 0.15); color: var(--warning);',
            error: 'background: rgba(255, 85, 102, 0.15); color: var(--error);',
            secondary: 'background: var(--bg-hover); color: var(--text-secondary);'
        };
        return `<span class="chip" style="${colors[t.color] || colors.secondary}">${escapeHtml(t.name)}</span>`;
    }).join('');
    
    document.getElementById('chatHeader').innerHTML = `
        <div class="chat-header-top">
            <div>
                <div class="chat-header-name">${escapeHtml(p.name || p.full_name)}</div>
                <div class="chat-header-company">${escapeHtml(p.company || p.phone)}</div>
            </div>
            <div class="chat-actions">
                <button class="chat-action-btn ${p.pinned ? 'active' : ''}" onclick="togglePin()" title="Pin">üìå</button>
                <button class="chat-action-btn" onclick="openModal('partnerActionsModal')" title="More">‚ãØ</button>
            </div>
        </div>
        <div class="chat-header-meta">
            ${p.region ? `<span class="chip">${escapeHtml(p.region)}</span>` : ''}
            ${p.tsd ? `<span class="chip">${escapeHtml(p.tsd)}</span>` : ''}
            ${tagsHtml}
            <span class="chip" id="bestTimeChip" style="background: rgba(102, 126, 234, 0.15); color: #667eea; display: none;">‚è∞ Loading...</span>
        </div>
        ${p.last_contacted ? `<div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 8px;">Last contacted: ${new Date(p.last_contacted).toLocaleDateString()}</div>` : ''}
        
        <div class="notes-section">
            <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">Notes</div>
            <textarea class="notes-textarea" id="partnerNotes" rows="2" placeholder="Add notes about this partner..." onblur="saveNotes()">${escapeHtml(p.notes || '')}</textarea>
        </div>
    `;
    
    // Update actions modal labels
    document.getElementById('pinLabel').textContent = p.pinned ? 'üìå Unpin conversation' : 'üìå Pin conversation';
    document.getElementById('archiveLabel').textContent = p.archived ? 'üì¶ Unarchive' : 'üì¶ Archive';
    document.getElementById('callLink').href = `tel:${p.phone}`;
    document.getElementById('partnerActionsTitle').textContent = p.name || p.full_name;
    
    // Load best time to text
    loadBestTime();
}

async function loadBestTime() {
    try {
        const res = await fetch(`/api/ai/best-time/${currentPartnerId}`);
        const data = await res.json();
        
        const chip = document.getElementById('bestTimeChip');
        if (data.best_time && data.confidence !== 'low') {
            chip.textContent = `‚è∞ Best: ${data.best_day} ${data.best_time}`;
            chip.style.display = 'inline-flex';
        }
    } catch (err) {
        // Silently fail
    }
}

async function saveNotes() {
    const notes = document.getElementById('partnerNotes').value;
    if (currentPartner.notes === notes) return;
    
    try {
        await fetch(`/api/partners/${currentPartnerId}/notes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes })
        });
        currentPartner.notes = notes;
        showToast('Notes saved');
    } catch (err) {
        showToast('Failed to save notes', 'error');
    }
}

async function togglePin() {
    try {
        const res = await fetch(`/api/partners/${currentPartnerId}/pin`, { method: 'POST' });
        const data = await res.json();
        currentPartner.pinned = data.pinned;
        renderChatHeader();
        showToast(data.pinned ? 'Conversation pinned' : 'Conversation unpinned');
        closeModal('partnerActionsModal');
    } catch (err) {
        showToast('Failed to update', 'error');
    }
}

async function toggleArchive() {
    try {
        const res = await fetch(`/api/partners/${currentPartnerId}/archive`, { method: 'POST' });
        const data = await res.json();
        currentPartner.archived = data.archived;
        showToast(data.archived ? 'Conversation archived' : 'Conversation unarchived');
        closeModal('partnerActionsModal');
        if (data.archived) showConversations();
    } catch (err) {
        showToast('Failed to update', 'error');
    }
}

function exportConversation() {
    window.location.href = `/api/partners/${currentPartnerId}/export?format=txt`;
    closeModal('partnerActionsModal');
}

function editPartnerFromChat() {
    closeModal('partnerActionsModal');
    window.location.href = `/partners?edit=${currentPartnerId}`;
}

function showConversations() {
    document.getElementById('chatView').classList.add('hidden');
    document.getElementById('composeBar').classList.add('hidden');
    document.getElementById('conversationsView').classList.remove('hidden');
    document.getElementById('backBtn').classList.add('hidden');
    document.getElementById('filterBtn').classList.remove('hidden');
    document.getElementById('searchBtn').classList.remove('hidden');
    document.getElementById('headerTitle').textContent = 'Inbox';
    
    currentPartnerId = null;
    currentPartner = null;
    
    history.replaceState(null, '', '/inbox');
    loadConversations();
}

async function loadMessages() {
    if (!currentPartnerId) return;
    
    try {
        const res = await fetch(`/api/messages/${currentPartnerId}`);
        const messages = await res.json();
        renderMessages(messages);
    } catch (err) {
        console.error(err);
    }
}

function renderMessages(messages) {
    const container = document.getElementById('messageList');
    
    if (messages.length === 0) {
        container.innerHTML = `<div class="empty-state"><p>No messages yet. Send the first one!</p></div>`;
        return;
    }
    
    container.innerHTML = messages.map(m => `
        <div class="message ${m.direction}">
            ${m.media_url ? renderMedia(m.media_url, m.media_type) : ''}
            ${m.body ? `<div>${escapeHtml(m.body)}</div>` : ''}
            <div class="message-time">
                ${formatMessageTime(m.created_at)}
                ${m.direction === 'outbound' ? getStatusIcon(m.status) : ''}
            </div>
        </div>
    `).join('');
    
    scrollToBottom();
}

function scrollToBottom() {
    const container = document.getElementById('messageList');
    container.scrollTop = container.scrollHeight;
    document.getElementById('newMessagesBtn').style.display = 'none';
}

function getStatusIcon(status) {
    if (status === 'delivered') return '<span class="message-status" style="color: var(--accent);">‚úì‚úì</span>';
    if (status === 'sent') return '<span class="message-status" style="color: var(--text-muted);">‚úì</span>';
    if (status === 'failed' || status === 'undelivered') return '<span class="message-status" style="color: var(--error);">‚úï</span>';
    if (status === 'queued' || status === 'sending') return '<span class="message-status" style="color: var(--text-muted);">‚è≥</span>';
    return '';
}

function renderMedia(url, type) {
    if (type === 'image') return `<div class="message-media"><img src="${url}" alt="Image" style="max-width:100%;border-radius:8px;cursor:pointer;" onclick="window.open('${url}')"></div>`;
    if (type === 'video') return `<div class="message-media"><video src="${url}" controls style="max-width:100%;border-radius:8px;"></video></div>`;
    if (type === 'audio') return `<div class="message-media"><audio src="${url}" controls style="width:100%;"></audio></div>`;
    return `<div class="message-media"><a href="${url}" target="_blank">üìé Attachment</a></div>`;
}

function handleKeydown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
}

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const body = input.value.trim();
    
    if (!body && !pendingMedia) return;
    if (currentPartner?.opted_out) return;
    
    const btn = document.getElementById('sendMsgBtn');
    btn.disabled = true;
    
    try {
        const data = { partner_id: currentPartnerId, message: body };
        if (pendingMedia) {
            data.media_url = pendingMedia.url;
            data.media_type = pendingMedia.type;
        }
        
        const res = await fetch('/api/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await res.json();
        if (result.success) {
            input.value = '';
            updateCharCountInbox();
            clearMediaPreview();
            loadMessages();
        } else {
            showToast(result.error || 'Failed to send', 'error');
        }
    } catch (err) {
        showToast('Failed to send message', 'error');
    } finally {
        btn.disabled = false;
    }
}

function handleMediaSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    uploadMedia(file);
}

async function uploadMedia(file) {
    const fd = new FormData();
    fd.append('file', file);
    
    try {
        const res = await fetch('/api/upload', { method: 'POST', body: fd });
        const data = await res.json();
        
        if (data.success) {
            pendingMedia = { url: data.url, type: data.media_type };
            showMediaPreview();
        } else {
            showToast(data.error || 'Upload failed', 'error');
        }
    } catch (err) {
        showToast('Upload failed', 'error');
    }
}

async function uploadMediaWithType(blob, type) {
    const fd = new FormData();
    fd.append('file', blob, `recording.webm`);
    fd.append('media_type', type);
    
    try {
        const res = await fetch('/api/upload', { method: 'POST', body: fd });
        const data = await res.json();
        
        if (data.success) {
            pendingMedia = { url: data.url, type: data.media_type };
            showMediaPreview();
        } else {
            showToast(data.error || 'Upload failed', 'error');
        }
    } catch (err) {
        showToast('Upload failed', 'error');
    }
}

function showMediaPreview() {
    const container = document.getElementById('mediaPreviewContainer');
    container.innerHTML = `
        <div style="background: var(--bg-dark); border-radius: 8px; padding: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 0.8rem; color: var(--accent);">üìé ${pendingMedia.type} attached</span>
            <button onclick="clearMediaPreview()" style="background: none; border: none; color: var(--text-muted); cursor: pointer;">‚úï</button>
        </div>
    `;
}

function clearMediaPreview() {
    pendingMedia = null;
    document.getElementById('mediaPreviewContainer').innerHTML = '';
}

// Recording functions
function startRecording(type) {
    currentRecordingType = type;
    const constraints = type === 'video' 
        ? { video: { facingMode: 'user' }, audio: true }
        : { audio: true };
    
    navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
            mediaStream = stream;
            
            if (type === 'video') {
                const preview = document.getElementById('videoPreview');
                preview.srcObject = stream;
                preview.style.display = 'block';
                preview.play();
            }
            
            mediaRecorder = new MediaRecorder(stream);
            recordedChunks = [];
            
            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };
            
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: type === 'video' ? 'video/webm' : 'audio/webm' });
                uploadMediaWithType(blob, currentRecordingType);
                cleanupRecording();
                closeModal('recordModal');
            };
            
            mediaRecorder.start();
            recordingSeconds = 0;
            updateRecordTimer();
            recordingTimer = setInterval(updateRecordTimer, 1000);
            
            document.getElementById('recordTitle').textContent = type === 'video' ? 'Recording Video...' : 'Recording Audio...';
            openModal('recordModal');
        })
        .catch(err => {
            showToast('Could not access microphone/camera', 'error');
        });
}

function updateRecordTimer() {
    recordingSeconds++;
    const mins = Math.floor(recordingSeconds / 60);
    const secs = recordingSeconds % 60;
    document.getElementById('recordTimer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
}

function stopRecording() {
    if (mediaRecorder?.state !== 'inactive') {
        mediaRecorder.stop();
    }
}

function cancelRecording() {
    if (mediaRecorder?.state !== 'inactive') mediaRecorder.stop();
    recordedChunks = [];
    cleanupRecording();
    closeModal('recordModal');
}

function cleanupRecording() {
    if (recordingTimer) { clearInterval(recordingTimer); recordingTimer = null; }
    if (mediaStream) { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; }
    document.getElementById('videoPreview').srcObject = null;
    document.getElementById('videoPreview').style.display = 'none';
    currentRecordingType = null;
}

// Search
let searchTimeout = null;

function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(performSearch, 300);
}

async function performSearch() {
    const query = document.getElementById('searchInput').value.trim();
    const resultsEl = document.getElementById('searchResults');
    
    if (query.length < 2) {
        resultsEl.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">Type at least 2 characters</div>';
        return;
    }
    
    resultsEl.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    try {
        const res = await fetch(`/api/messages/search?q=${encodeURIComponent(query)}`);
        const results = await res.json();
        
        if (results.length === 0) {
            resultsEl.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No messages found</div>';
            return;
        }
        
        resultsEl.innerHTML = results.map(r => `
            <div class="convo-item" onclick="goToMessage(${r.partner_id})" style="margin-bottom: 8px;">
                <div class="convo-avatar">${getInitials(r.partner_name)}</div>
                <div class="convo-content">
                    <div class="convo-name">${escapeHtml(r.partner_name)}</div>
                    <div class="convo-preview">${r.direction === 'inbound' ? '‚Üê ' : '‚Üí '}${escapeHtml(r.body?.substring(0, 50) || '')}${r.body?.length > 50 ? '...' : ''}</div>
                </div>
                <div class="convo-meta">
                    <div class="convo-time">${formatTime(r.created_at)}</div>
                </div>
            </div>
        `).join('');
    } catch (err) {
        resultsEl.innerHTML = '<div style="text-align: center; color: var(--error); padding: 20px;">Search failed</div>';
    }
}

function goToMessage(partnerId) {
    closeModal('searchModal');
    document.getElementById('searchInput').value = '';
    openConversation(partnerId);
}

// Utility functions
function getInitials(name) { return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase(); }

function formatTime(iso) {
    if (!iso) return '';
    const diff = Date.now() - new Date(iso);
    if (diff < 60000) return 'Now';
    if (diff < 3600000) return Math.floor(diff/60000) + 'm';
    if (diff < 86400000) return Math.floor(diff/3600000) + 'h';
    return new Date(iso).toLocaleDateString();
}

function formatMessageTime(iso) { return new Date(iso).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

// Scroll detection for new messages button
document.getElementById('messageList')?.addEventListener('scroll', function() {
    const el = this;
    const isNearBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 100;
    document.getElementById('newMessagesBtn').style.display = isNearBottom ? 'none' : 'block';
});

// AI Functions
async function getAiSuggestions() {
    if (!currentPartnerId) return;
    
    const btn = document.getElementById('aiSuggestBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥...';
    
    try {
        const res = await fetch(`/api/ai/suggestions/${currentPartnerId}`, { method: 'POST' });
        const data = await res.json();
        
        if (data.error) {
            showToast(data.error, 'error');
            return;
        }
        
        const container = document.getElementById('aiSuggestionsList');
        container.innerHTML = data.suggestions.map(s => 
            `<button class="ai-suggestion-btn" onclick="useAiSuggestion(this)">${escapeHtml(s)}</button>`
        ).join('');
        
        document.getElementById('aiSuggestions').classList.remove('hidden');
    } catch (err) {
        showToast('Failed to get suggestions', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'üí° Suggest';
    }
}

function useAiSuggestion(btn) {
    document.getElementById('messageInput').value = btn.textContent;
    updateCharCountInbox();
    hideAiSuggestions();
}

function hideAiSuggestions() {
    document.getElementById('aiSuggestions').classList.add('hidden');
}

async function generateAiMessage() {
    const input = document.getElementById('aiComposeInput');
    const prompt = input.value.trim();
    
    if (!prompt) {
        showToast('Enter what you want to write', 'warning');
        return;
    }
    
    const btn = document.getElementById('aiComposeBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥...';
    
    try {
        const res = await fetch('/api/ai/compose', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                prompt: prompt,
                partner_id: currentPartnerId 
            })
        });
        const data = await res.json();
        
        if (data.error) {
            showToast(data.error, 'error');
            return;
        }
        
        document.getElementById('messageInput').value = data.message;
        updateCharCountInbox();
        input.value = '';
        showToast('Message generated!');
    } catch (err) {
        showToast('Failed to generate message', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = '‚ú® Write';
    }
}

async function getAiSummary() {
    if (!currentPartnerId) return;
    
    try {
        const res = await fetch(`/api/ai/summarize/${currentPartnerId}`);
        const data = await res.json();
        
        if (data.error) {
            showToast(data.error, 'error');
            return;
        }
        
        // Show in a modal or alert
        alert('Conversation Summary:\n\n' + data.summary);
    } catch (err) {
        showToast('Failed to summarize', 'error');
    }
}

async function getAiSentiment() {
    if (!currentPartnerId) return;
    
    try {
        const res = await fetch(`/api/ai/sentiment/${currentPartnerId}`);
        const data = await res.json();
        return data;
    } catch (err) {
        return { sentiment: 'neutral', score: 50, label: 'Unknown' };
    }
}

loadConversations();
</script>
{% endblock %}
